---
title: "PEDLR - Simulation"
output:
  html_document:
    toc: yes
    self_contained: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 3
    number_sections: False
    highlight: pygments
    theme: cosmo
    code_folding: "hide"
    df_print: paged
    fig_caption: true
  pdf_document:
    toc: yes
    fig_caption: true
    latex_engine: xelatex
fig.align: "center"
header-includes:
  - \usepackage{fontspec}
  - \setmainfont{AgfaRotisSansSerif}
email: koch@mpib-berlin.mpg.de
---

# Paths and libraries

- Import libraries

```{r message=FALSE}
library(reshape2)
library(ggplot2)
library(plotly)
library(plyr)
library(Rfast)
library(data.table)
library(knitr)
#library(rstudioapi)
#library(here)
library(viridis)
library(cowplot)
```

- Set paths

```{r}
base_path = file.path('/Volumes', 'MPRG-Neurocode', 'Users', 'christoph', 'pedlr')
derivatives_path = file.path(base_path, 'derivatives', 'simulation')
source_path = file.path(base_path, 'code', 'simulation')
```

- Import own functions

```{r}
# Source functions required for this script
source(file.path(source_path, 'Beta_pseudo_sim.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'Gaussian_pseudo_sim.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'Uniform_pseudo_sim.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'Bimodal_pseudo_sim.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'Create_design_complete.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'Sample_subjects.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'PE_dep_LR_choice_model.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'Pedlr.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'Pedlr_interdep.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'Softmax_choice.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'PE_dep_LR_single_model.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'Apply_model.R', fsep = .Platform$file.sep))
source(file.path(source_path, 'Model_results.R', fsep = .Platform$file.sep))
```

---

# Parameter set-up

## Model

- Model parameters

```{r}
alpha0 = 0.3
alpha1 = 0.7
temperature = 7
```

- Set up reward space

```{r}
# Reward lower and upper boundary
reward_space_lb = 1
reward_space_ub = 100

# Set up space for plotting
reward_space_length = 1000
reward_space = seq(reward_space_lb, 
                   reward_space_ub,
                   length=reward_space_length)
```

- Set rare event threshold

```{r}
# Set rare events to be 20% of the sampled data
rare_lim = 0.2
```


## Distributions

### Gaussian

```{r}
# Parameters
gaussian_mean = (100 * 1/6) * 3
gaussian_sd = (100 * 1/6) / 3

# Distribution
gaussian_densities = dnorm(reward_space, gaussian_mean, gaussian_sd)
# Normalize densities
gaussian_densities = scale(gaussian_densities) - min(scale(gaussian_densities))
```

### Beta

```{r}
# Set up "skewdness" parameter for easier change of slope
beta_skewedness = 5
# Parameters for lower end beta and upper end beta
beta_a_le = beta_skewedness/3
beta_b_le = 2*beta_skewedness/3
beta_a_ue = 2*beta_skewedness/3
beta_b_ue = beta_skewedness/3
# Create distributions
beta_densities_le = dbeta(seq(0,1,length=reward_space_length), beta_a_le,beta_b_le)
beta_densities_ue = dbeta(seq(0,1,length=reward_space_length), beta_a_ue,beta_b_ue)
# Normalize densities
beta_densities_le = scale(beta_densities_le) - min(scale(beta_densities_le))
beta_densities_ue = scale(beta_densities_ue) - min(scale(beta_densities_le))
```

### Uniform

```{r}
# Parameters
uniform_min = reward_space_lb
uniform_max = reward_space_ub

# Distribution (cannot be normalized because of sd = 0)
uniform_densities = dunif(reward_space, uniform_min, uniform_max)
# Make distirbution visible in plot
uniform_densities = uniform_densities + 0.3
```

### Bimodal

```{r}
# Parameters
## Main mount of bimodal distribution
bimodal_main_mean = (100 * 1/6) * 2
bimodal_main_sd = gaussian_sd
## Second mount
bimodal_second_mean = bimodal_main_mean + 40
bimodal_second_sd = gaussian_sd
## Relative proportion of sampling different mounts
bimodal_rel_proportion = 0.2

# Distribution
# Get probability to sample each value over reward space given main distribution
bimodal_main_densities = dnorm(reward_space,
                               mean = bimodal_main_mean,
                               sd = bimodal_main_sd)
# Get probability to sample each value over reward space given second distribution
bimodal_second_densities = dnorm(reward_space,
                                 mean = bimodal_second_mean,
                                 sd = bimodal_second_sd)
# Fuse sample probabilities given relative ratio of second distribution
bimodal_densities = bimodal_main_densities + bimodal_rel_proportion * bimodal_second_densities
# Normalize densities
bimodal_densities = scale(bimodal_densities) - min(scale(bimodal_densities))
```

---

# Control plots

## Density functions of used distributions

- Plot distributions

```{r out.width='100%', warning=FALSE}
# Form data frame from density values
data_densities = data.frame(reward_space, 
                            gaussian_densities,
                            beta_densities_le,
                            beta_densities_ue,
                            uniform_densities,
                            bimodal_densities)
colnames(data_densities) = c('reward_space', 'Gaussian', 'Beta (gain)', 'Beta (loss)', 'Uniform', 'Bimodal')

# Bring data frame into long format
data_densities = melt(data_densities, id.vars='reward_space')

# Disribution plot
p_dist = ggplot(data=data_densities, aes(x=reward_space, y=value, group=as.factor(variable),
                                         color=as.factor(variable))) +
  geom_line(size=1) +
  #scale_color_manual(values = c(color$gaussian, color$gain, color$loss)) +
  scale_x_continuous(limits = c(1,100)) +
  #stat_summary(fun.data = 'mean', geom = 'vline') +
  geom_vline(xintercept=c(1/3, 1/2, 2/3)*100, linetype='dashed', alpha=0.5, size=0.1) +
  labs(title='Density functions of used distributions',
       x='Outcome',
       y='Normalized density',
       color='Distributions') +
  scale_y_continuous(limits=c(0,4.5)) +
  theme(plot.title=element_text(size=15, face='bold', hjust=0.5),
        axis.title=element_text(size=12))

p_dist
```

**Annotation:** This plot does not correctly reflect the normalized density of the **uniform distribution**. 
Because it's standard deviation is 0 it cannot be normalized. The uniform density was **artificially raised**
to be visible in comparison to the other density functions.

## Sampling functions

- Sample rewards from distributions (depending on how many blocks use the same distributions)

```{r out.width='100%', warning=FALSE}

# Create template of plotting data frame
data_sampling = data.frame(matrix(NA, 0, 4))
colnames(data_sampling) = c('Samples', 'n_blocks', 'variable', 'value')

# Loop over different amount of blocks for a task (depending on design)
for(block_count in seq(3)){
  
  # Define parameters
  # (each block has 80 samples for each of the three distributions used)
  n_samples = block_count * 80
  data = data.frame(c(1:n_samples))
  colnames(data) = 'Sample'
  data$n_blocks = block_count
  
  # Fill data frame with samples
  data$beta_le = Beta_pseudo_sim(n_samples,
                                          beta_a_le,
                                          beta_b_le,
                                          'b_le',
                                          reward_space_lb,
                                          reward_space_ub)$outcome
  data$gaussian = Gaussian_pseudo_sim(n_samples,
                                               gaussian_mean,
                                               gaussian_sd,
                                               'g_an',
                                               reward_space_lb,
                                               reward_space_ub)$outcome
  data$beta_ue = Beta_pseudo_sim(n_samples,
                                          beta_a_ue,
                                          beta_b_ue,
                                          'b_ue',
                                          reward_space_lb,
                                          reward_space_ub)$outcome
  data$uniform = Uniform_pseudo_sim(n_samples,
                                             uniform_min,
                                             uniform_max,
                                             'uniform',
                                             reward_space_lb,
                                             reward_space_ub)$outcome
  data$bimodal = Bimodal_pseudo_sim(n_samples,
                                             main.mean = bimodal_main_mean,
                                             main.sd = bimodal_main_sd,
                                             second.mean = bimodal_second_mean,
                                             second.sd = bimodal_second_sd,
                                             relative_proportion = bimodal_rel_proportion,
                                             dist_name = 'bimodal',
                                             reward_space_lb,
                                             reward_space_ub)$outcome
  data = melt(data, id.vars=c('Sample', 'n_blocks'))
  
  data_sampling = rbind(data_sampling, data)
}
```

- Plot samples for each distribution and number of blocks

```{r, out.width="100%"}
# Plot histograms
p_sampling = ggplot(data=data_sampling, aes(x=value, fill=variable)) +
  #scale_fill_manual(values=c(color$gain, color$gaussian, color$loss)) +
  geom_histogram(binwidth = 1) +
  facet_grid(rows = vars(n_blocks), cols = vars(variable))

p_sampling
```

**Annotation:** This plot illustates that **equal sampling of the whole space** is only possible if there are
**enough events** for each distribution. Two blocks per task should be recommended so the sampled values are
appropriately reflecting the distribution they come from. 

---

# Model simulations

- Set number of subjects

```{r}
n_subjects = 40
```

- Set distributions for task design

```{r}
# Gaussian
# SD similar for all Gaussians
gaussian_sd = (100 * 1/6) / 3
# Mean of different Gaussians
# Lower end
gaussian_le_mean = (100 * 1/6) * 1
# Mid
gaussian_mid_mean = (100 * 1/6) * 3
# Upper end
gaussian_ue_mean = (100 * 1/6) * 5

# Betas
# Set up "skewdness" parameter for easier change of slope
beta_skewedness = 5
# Gain Beta
beta_a_gain = beta_skewedness/3
beta_b_gain = 2*beta_skewedness/3
# Loss Beta
beta_a_loss = 2*beta_skewedness/3
beta_b_loss = beta_skewedness/3

# Uniform
uniform_min = reward_space_lb
uniform_max = reward_space_ub

# Bimodal
## Main mount of bimodal distribution
bimodal_main_mean = (100 * 1/6) * 2
bimodal_main_sd = gaussian_sd
## Second mount
bimodal_second_mean = bimodal_main_mean + 40
bimodal_second_sd = gaussian_sd
## Relative proportion of sampling different mounts
bimodal_rel_proportion = 0.2
```

- Set parameters for task design

```{r}
# Number of overall blocks
n_blocks = 6
# Number of blocks dedicated to each task version
blocks_per_task = 3
# Percentage of forced choice trials
perc_forced = 20
# List of different distributions with parameters (three distributions for each task version)
dist_list = list(c('gaussian', gaussian_le_mean, gaussian_sd),
                 c('bimodal', bimodal_main_mean, gaussian_sd,
                   bimodal_second_mean, gaussian_sd,
                   bimodal_rel_proportion),
                 c('gaussian', gaussian_mid_mean, gaussian_sd),
                 c('gaussian', gaussian_mid_mean, gaussian_sd),
                 c('uniform', uniform_min, uniform_max),
                 c('gaussian', gaussian_ue_mean, gaussian_sd))
```

- Plot samples for each task version

```{r}
# Create design to get sampling for each distribution in each task version
design = Create_design(n_blocks = n_blocks,
                       perc_forced = perc_forced,
                       blocks_per_task = blocks_per_task,
                       dist_list = dist_list)

# Create template to check sampling of each distribution
data_plot = data.frame(matrix(NA, 0, 3))
colnames(data_plot) = c('task_version', 'stimulus', 'samples')

# For each task version
for(version_count in unique(design$task_version)){
  data = subset(design, task_version == version_count)
  # For each of the three distributions per task version
  for(stim_count in sort(unique(data$option_left))){
    # Get data frame of rewards sampled for each stimulus (regardless if presented
    # left or right) and task version
    samples = data.frame(c(data$reward_stim_1[data$option_left == stim_count],
                data$reward_stim_2[data$option_right == stim_count]))
    samples$task_version = version_count
    samples$stimulus = stim_count
    colnames(samples) = c('samples', 'task_version', 'stimulus')
    # Add samples to plotting data
    data_plot = rbind(data_plot, samples)
  }
}

# Prepare for plotting
data_plot$stimulus = as.factor(data_plot$stimulus)
# Plot sampling for each task version and stimulus
p_sampling = ggplot(data = data_plot, aes(x = samples, fill = stimulus)) +
  geom_histogram(binwidth = 1) +
  # facet_grid(rows = vars(task_version),
  #            cols = vars(stimulus))
  facet_wrap(~ task_version + stimulus)

# Display plot
p_sampling
```

- Simulate data for number of subjects

```{r}
data_sim = Sample_subjects(n_subjects = n_subjects,
                           set_seed = TRUE,
                           n_blocks = n_blocks,
                           perc_forced = perc_forced,
                           blocks_per_task = blocks_per_task,
                           dist_list = dist_list)
```

## Apply models

### Pedlr

- Set model parameters

```{r}
alpha0 = 0.3
alpha1 = 0.7
temperature = 7
choice_policy = 'softmax'
init_values = list(c(50,50,50),
                   c(50,50,50))

# Convert to data frame to pass to function
parameters = data.frame(matrix(NA, 1, 5))
colnames(parameters) = c('alpha0',
                         'alpha1',
                         'temperature',
                         'reward_space_ub',
                         'choice_policy')
parameters$alpha0 = alpha0
parameters$alpha1 = alpha1
parameters$temperature = temperature
parameters$reward_space_ub = reward_space_ub
parameters$choice_policy = choice_policy
```

- Apply model to each simulated subject

```{r}
data_model = ddply(data_sim,
                   "sub_id",
                   Apply_model,
                   model = 'Pedlr',
                   parameters = parameters,
                   init_values = init_values)
```

#### Results

```{r, out.width="100%"}
results = Model_results(results = data_model,
                     last_perc_of_trials = 25,
                     average_subjects = TRUE,
                     mean_value_calculation = 'chosen_trials')
data_bias = results$bias
plot = results$plot
plot
```

### Pedlr_interdep

- Set model parameters

```{r}
alpha0 = 0.3
alpha1 = 0.7
temperature = 7
choice_policy = 'softmax'
interdep = 0.5
init_values = list(c(50,50,50),
                   c(50,50,50))

# Convert to data frame to pass to function
parameters = data.frame(matrix(NA, 1, 6))
colnames(parameters) = c('alpha0',
                         'alpha1',
                         'temperature',
                         'reward_space_ub',
                         'choice_policy',
                         'interdep')
parameters$alpha0 = alpha0
parameters$alpha1 = alpha1
parameters$temperature = temperature
parameters$reward_space_ub = reward_space_ub
parameters$choice_policy = choice_policy
parameters$interdep = interdep
```

- Apply model to each simulated subject

```{r}
data_model = ddply(data_sim,
                   "sub_id",
                   Apply_model,
                   model = 'Pedlr_interdep',
                   parameters = parameters,
                   init_values = init_values)
```

#### Results

```{r, out.width="100%"}
results = Model_results(results = data_model,
                        last_perc_of_trials = 25,
                        average_subjects = TRUE,
                        mean_value_calculation = 'chosen_trials')
data_bias = results$bias
plot = results$plot
plot
```

---

# Bias analysis

See how the bias between real (sampling) mean and estimated mean develops depending on model parameters.

### Pedlr

- Create list of parameters to test

```{r}
# Steps in which to loop over each parameter
steps_alpha0 = seq(from = 0, to = 1, length.out = 6)
steps_alpha1 = seq(from = 0, to = 1, length.out = 6)
steps_temperature = seq(from = 1, to = 30, length.out = 6)
steps_policy = c('softmax', 'greedy')

# Get all combinations of parameters
parameters = data.table(expand.grid(steps_alpha0,
                                    steps_alpha1,
                                    steps_temperature,
                                    steps_policy))
colnames(parameters) = c('alpha0', 'alpha1', 'temperature', 'choice_policy')

# Add constant parameters
parameters$reward_space_ub = reward_space_ub
```

- Set variables for model

```{r}
last_perc_of_trials = 35
average_subjects = TRUE
mean_value_calculation = 'chosen_trials'
```


```{r}
data = cbind(data_bias[0,], parameters[0,])

for(run_count in seq(nrow(parameters))){
  # Apply model with different parameters to subjects
  data_model = ddply(data_sim,
                     "sub_id",
                     Apply_model,
                     model = 'Pedlr',
                     parameters = parameters[run_count,],
                     init_values = init_values)
  # Get bias for specific parameters
  results = Model_results(results = data_model,
                          last_perc_of_trials = last_perc_of_trials,
                          average_subjects = average_subjects,
                          mean_value_calculation = mean_value_calculation)
  data_bias = cbind(results$bias,
                    do.call("rbind",
                            replicate(nrow(data_bias),
                                      parameters[run_count,],
                                      simplify = FALSE)))
  
  data = rbind(data, data_bias)
}

# Add model variables to data
data$last_perc_of_trials = last_perc_of_trials
data$average_subjects = as.numeric(average_subjects)
data$mean_value_calculation = mean_value_calculation

# Save bias simulation
file = file.path(derivatives_path, 'bias_simulation.tsv')
write.table(data, file, sep='\t', row.names = FALSE)
```








<!-- ## Plot results of choice model -->

<!-- - All choices -->

<!-- ```{r warning=FALSE} -->
<!-- # Cut down data frame for plotting -->
<!-- data_plot = data_model[,1:11] -->
<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'stim_1', -->
<!--                                       'stim_2', -->
<!--                                       'reward_stim_1', -->
<!--                                       'reward_stim_2', -->
<!--                                       'choice', -->
<!--                                       'comp_number')) -->

<!-- # Average over all subjects -->
<!-- data_plot = ddply(data_plot, -->
<!--                   .(trial, variable), -->
<!--                   summarize, -->
<!--                   mean_value = mean(value), -->
<!--                   sd_value = sd(value)) -->

<!-- # Plot model values -->
<!-- p_choice = ggplot(data=data_plot, aes(x=trial, y=mean_value, group=variable, color=variable)) + -->
<!--   geom_hline(yintercept=c(1/3*100, 50, 2/3*100), linetype='dashed') + -->
<!--   geom_hline(yintercept=c(mean(subset(data_plot, variable == 'v_stim_1')$mean_value), -->
<!--                           mean(subset(data_plot, variable == 'v_stim_2')$mean_value), -->
<!--                           mean(subset(data_plot, variable == 'v_stim_3')$mean_value)), -->
<!--              color = c(color$gain, color$gaussian, color$loss)) + -->
<!--   geom_line(size=1, alpha=0.8) + -->
<!--   scale_color_manual(values = c(color$gain, color$gaussian, color$loss)) + -->
<!--   labs(title=paste('Choice model performance (α0=', alpha0, ', α1=', alpha1, ', τ=', temperature, ')', sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') -->
<!-- ggplotly(p_choice) -->
<!-- ``` -->

<!-- - Average over only chosen option over all participants -->

<!-- ```{r} -->
<!-- data_plot = data_model[,1:11] -->
<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'stim_1', -->
<!--                                       'stim_2', -->
<!--                                       'reward_stim_1', -->
<!--                                       'reward_stim_2', -->
<!--                                       'choice', -->
<!--                                       'comp_number')) -->
<!-- # Select only choices of stim 1 to calculate mean value (leaving out plateaus) -->
<!-- data_1 = subset(data_plot, choice == 1 & variable == 'v_stim_1') -->
<!-- # Calculate mean value of dist 1 WHEN CHOSEN -->
<!-- mean_1 = mean(data_1$value, na.rm = TRUE) -->

<!-- # Same for 2 -->
<!-- data_2 = subset(data_plot, choice == 2 & variable == 'v_stim_2') -->
<!-- mean_2 = mean(data_2$value, na.rm = TRUE) -->

<!-- # Same for 3 -->
<!-- data_3 = subset(data_plot, choice == 3 & variable == 'v_stim_3') -->
<!-- mean_3 = mean(data_3$value, na.rm = TRUE) -->

<!-- # Average over all subjects -->
<!-- data_plot = ddply(data_plot, -->
<!--                   .(trial, variable), -->
<!--                   summarize, -->
<!--                   mean_value = mean(value), -->
<!--                   sd_value = sd(value)) -->

<!-- # Plot model values -->
<!-- p = ggplot(data=data_plot, aes(x=trial, y=mean_value, group=variable, color=variable)) + -->
<!--   geom_hline(yintercept=c(1/3*100, 50, 2/3*100), linetype='dashed') + -->
<!--   geom_hline(yintercept=c(mean_1, -->
<!--                           mean_2, -->
<!--                           mean_3), -->
<!--              color=c(color$gain, color$gaussian, color$loss)) + -->
<!--   geom_line(size=1, alpha=0.8) + -->
<!--   scale_color_manual(values = c(color$gain, color$gaussian, color$loss)) + -->
<!--   labs(title=paste('Choice model performance (α0=', alpha0, ', α1=', alpha1, ', τ=', temperature, ')', sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') -->
<!-- p = ggplotly(p) -->

<!-- p -->
<!-- ``` -->

<!-- - Single participant -->

<!-- ```{r, warning=FALSE, message=FALSE} -->
<!-- # Cut down data frame for plotting -->
<!-- data_plot = data_model[,1:11] -->
<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'stim_1', -->
<!--                                       'stim_2', -->
<!--                                       'reward_stim_1', -->
<!--                                       'reward_stim_2', -->
<!--                                       'choice', -->
<!--                                       'comp_number')) -->

<!-- # Select single subject -->
<!-- #data_plot = subset(data_plot, sub_id == 1) -->

<!-- # Plot model values -->
<!-- p_choice = ggplot(data=data_plot, aes(x=trial, y=value, group=variable, color=variable)) + -->
<!--   theme_bw() + -->
<!--   geom_hline(yintercept=c(1/3 *100, 50, 2/3*100), linetype='dashed', -->
<!--              size=0.1) + -->
<!--   # geom_hline(yintercept=c(mean(subset(data_plot, variable == 'v_stim_1')$mean_value), -->
<!--   #                         mean(subset(data_plot, variable == 'v_stim_2')$mean_value), -->
<!--   #                         mean(subset(data_plot, variable == 'v_stim_3')$mean_value)), -->
<!--   #            color = c(color$gain, color$gaussian, color$loss)) + -->
<!--   geom_line(size=0.1, alpha=0.8) + -->
<!--   scale_color_manual(values=c(color$gain, color$gaussian, color$loss)) + -->
<!--   labs(title=paste('Choice model performance (alpha0=', alpha0, ', alpha1=', alpha1, ', temp=', temperature, ')', sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') + -->
<!--   facet_wrap( ~ sub_id, ncol = 8) + -->
<!--   theme(legend.position = 'none', -->
<!--         axis.text = element_text(size=5), -->
<!--         strip.text = element_text(size=5), -->
<!--         panel.grid = element_blank()) -->
<!-- ggplotly(p_choice) -->
<!-- ``` -->

<!-- ```{r, warning=FALSE, message=FALSE} -->
<!-- file = '/Volumes/MPRG-Neurocode/Users/christoph/pedlr/code/simulation/figures/choice_bc.pdf' -->
<!-- ggsave(file, plot = p_choice, height=11, width=20, unit='cm') -->
<!-- ``` -->


<!-- --- -->

<!-- # Single model -->

<!-- ## Gain beta -->

<!-- - Use single model on gain beta rewards from design -->

<!-- ```{r} -->
<!-- # Set up matrix to store data in (to append subjects) -->
<!-- data_model_single_gain = data.frame(matrix(0,0,6)) -->
<!-- colnames(data_model_single_gain)= c('sub_id', 'trial', 'reward', 'value', 'PE', 'fPE') -->

<!-- # Loop over each subject -->
<!-- for(sub_count in subjects){ -->
<!--   # Simulate data for subject -->
<!--   design = Create_design_var_forced(n_miniblocks, -->
<!--                                     perc_forced, -->
<!--                                     beta_a_le, beta_b_le, -->
<!--                                     gaussian_mean, gaussian_sd, -->
<!--                                     beta_a_ue, beta_b_ue, -->
<!--                                     two_betas = TRUE, -->
<!--                                     reward_space_lb, reward_space_ub) -->
<!--   # Extract gain beta rewards -->
<!--   reward_index_left = which(design$option_left == 1) -->
<!--   # Eliminate forced choice trials from left stimulus -->
<!--   reward_index_right = which(design$option_right == 1) -->
<!--   reward_index_right = reward_index_right[-which(reward_index_right %in% reward_index_left)] -->
<!--   reward = c(design$reward_stim_1[reward_index_left], design$reward_stim_2[reward_index_right]) -->

<!--   # Fill design with rewards stemming only from gain beta sampling -->
<!--   design = data.frame(matrix(NA, length(reward), 2)) -->
<!--   colnames(design) = c('trial', 'reward') -->
<!--   design$trial = c(1:nrow(design)) -->
<!--   design$reward = reward -->

<!--   # Create subject specific 'results' data frame to append subjects -->
<!--   results = data.frame(matrix(NA, nrow(design), 6)) -->
<!--   colnames(results) = c('sub_id', 'trial', 'reward', 'value', 'PE', 'fPE') -->
<!--   results[,1] = sub_count -->
<!--   results[,2:3] = design -->

<!--   # Run model over simulated data -->
<!--   sim = PE_dep_LR_single_model(design, alpha0, alpha1, temperature) -->
<!--   # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--   results[,4] = sim$values$value[-length(sim$values$value)] -->
<!--   results[,5] = sim$PE$pe -->
<!--   results[,6] = sim$fPE$fpe -->

<!--   # Append all subjects -->
<!--   data_model_single_gain = rbind(data_model_single_gain, results) -->
<!-- } -->

<!-- # Sort after participants -->
<!-- data_model_single_gain = data_model_single_gain[order(data_model_single_gain$sub_id),] -->
<!-- ``` -->

<!-- - Plot model performing on single gain beta extracted from task design -->

<!-- ```{r} -->
<!-- # Prepare data frame for plotting -->
<!-- data_plot = data_model_single_gain[1:4] -->

<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'reward')) -->

<!-- # Average over all subjects -->
<!-- data_plot = ddply(data_plot, -->
<!--                   .(trial, variable), -->
<!--                   summarize, -->
<!--                   mean_value = mean(value), -->
<!--                   sd_value = sd(value)) -->

<!-- # Plot model values -->
<!-- p_choice = ggplot(data=data_plot, aes(x=trial, y=mean_value, group=variable)) + -->
<!--   geom_line(size=1, alpha=0.8, -->
<!--             color=color$gain) + -->
<!--   geom_hline(yintercept=1/3*100, linetype='dashed') + -->
<!--   geom_hline(aes(yintercept=mean(mean_value)), -->
<!--              color=color$gain) + -->
<!--   labs(title=paste('Single model performance (α0=', alpha0, ', α1=', alpha1, ', τ=', temperature, ')', sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') + -->
<!--   theme(legend.position = 'none') -->
<!-- ggplotly(p_choice) -->

<!-- ``` -->

<!-- ## Loss beta -->

<!-- - Use single model on loss beta rewards from design -->

<!-- ```{r} -->
<!-- # Set up matrix to store data in (to append subjects) -->
<!-- data_model_single_loss = data.frame(matrix(0,0,6)) -->
<!-- colnames(data_model_single_loss)= c('sub_id', 'trial', 'reward', 'value', 'PE', 'fPE') -->

<!-- # Loop over each subject -->
<!-- for(sub_count in subjects){ -->
<!--   # Simulate data for subject -->
<!--   design = Create_design_var_forced(n_miniblocks, -->
<!--                                     perc_forced, -->
<!--                                     beta_a_le, beta_b_le, -->
<!--                                     gaussian_mean, gaussian_sd, -->
<!--                                     beta_a_ue, beta_b_ue, -->
<!--                                     two_betas = TRUE, -->
<!--                                     reward_space_lb, reward_space_ub) -->
<!--   # Extract gain beta rewards -->
<!--   reward_index_left = which(design$option_left == 3) -->
<!--   # Eliminate forced choice trials from left stimulus -->
<!--   reward_index_right = which(design$option_right == 3) -->
<!--   reward_index_right = reward_index_right[-which(reward_index_right %in% reward_index_left)] -->
<!--   reward = c(design$reward_stim_1[reward_index_left], design$reward_stim_2[reward_index_right]) -->

<!--   # Fill design with rewards stemming only from gain beta sampling -->
<!--   design = data.frame(matrix(NA, length(reward), 2)) -->
<!--   colnames(design) = c('trial', 'reward') -->
<!--   design$trial = c(1:nrow(design)) -->
<!--   design$reward = reward -->

<!--   # Create subject specific 'results' data frame to append subjects -->
<!--   results = data.frame(matrix(NA, nrow(design), 6)) -->
<!--   colnames(results) = c('sub_id', 'trial', 'reward', 'value', 'PE', 'fPE') -->
<!--   results[,1] = sub_count -->
<!--   results[,2:3] = design -->

<!--   # Run model over simulated data -->
<!--   sim = PE_dep_LR_single_model(design, alpha0, alpha1, temperature) -->
<!--   # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--   results[,4] = sim$values$value[-length(sim$values$value)] -->
<!--   results[,5] = sim$PE$pe -->
<!--   results[,6] = sim$fPE$fpe -->

<!--   # Append all subjects -->
<!--   data_model_single_loss = rbind(data_model_single_loss, results) -->
<!-- } -->

<!-- # Sort after participants -->
<!-- data_model_single_loss = data_model_single_loss[order(data_model_single_loss$sub_id),] -->
<!-- ``` -->

<!-- - Plot model performing on single loss beta extracted from task design -->

<!-- ```{r} -->
<!-- # Prepare data frame for plotting -->
<!-- data_plot = data_model_single_loss[1:4] -->

<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'reward')) -->

<!-- # Average over all subjects -->
<!-- data_plot = ddply(data_plot, -->
<!--                   .(trial, variable), -->
<!--                   summarize, -->
<!--                   mean_value = mean(value), -->
<!--                   sd_value = sd(value)) -->

<!-- # Plot model values -->
<!-- p_choice = ggplot(data=data_plot, aes(x=trial, y=mean_value, group=variable, color=variable)) + -->
<!--   geom_line(size=1, alpha=0.8, -->
<!--             color=color$loss) + -->
<!--   geom_hline(yintercept=2/3*100, linetype='dashed') + -->
<!--   geom_hline(aes(yintercept=mean(mean_value)), -->
<!--              color=color$loss) + -->
<!--   labs(title=paste('Single model performance (α0=', alpha0, ', α1=', alpha1, ', τ=', temperature, ')', sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') + -->
<!--   theme(legend.position = 'none') -->
<!-- ggplotly(p_choice) -->

<!-- ``` -->

<!-- --- -->

<!-- # Choice model policy switch -->

<!-- Alternative model which can switch between greedy and softmax (and can use a variable reward space). -->

<!-- ## Softmax choice -->

<!-- ```{r} -->
<!-- # Set up matrix to store data in (to append subjects) -->
<!-- data_model = data.frame(matrix(0,0,18)) -->

<!-- # Loop over each subject -->
<!-- for(sub_count in subjects){ -->

<!--   set.seed(sub_count) -->

<!--   # Simulate data for subject -->
<!--   design = Create_design_var_forced(n_miniblocks, -->
<!--                                     perc_forced, -->
<!--                                     beta_a_le, beta_b_le, -->
<!--                                     gaussian_mean, gaussian_sd, -->
<!--                                     beta_a_ue, beta_b_ue, -->
<!--                                     two_betas = TRUE, -->
<!--                                     reward_space_lb, reward_space_ub) -->

<!--   # Create matrix to store data for each subject -->
<!--   results = data.frame(matrix(0,nrow(design),ncol(data_model))) -->
<!--   results[,1] = subjects[sub_count] -->
<!--   results[,2] = c(1:nrow(design)) -->
<!--   results[,3] = design$option_left -->
<!--   results[,4] = design$option_right -->
<!--   results[,5] = design$reward_stim_1 -->
<!--   results[,6] = design$reward_stim_2 -->
<!--   results[,7] = design$comp_number -->

<!--   # Run model over simulated data -->
<!--   sim = Pedlr(design, alpha0, alpha1, temperature, reward_space_ub, 'softmax') -->
<!--   # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--   results[,8] = sim$choices$choice -->
<!--   results[,9] = sim$choices$choice_prob -->
<!--   results[,10:12] = sim$values -->
<!--   results[,13:15] = sim$PE -->
<!--   results[,16:18] = sim$fPE -->

<!--   # Append all subjects -->
<!--   data_model = rbind(data_model, results) -->
<!-- } -->

<!-- # Convert to data frame (How our data will look like in the study) -->
<!-- data_model = data.frame(data_model) -->
<!-- colnames(data_model) = c('sub_id', 'trial', 'stim_1', 'stim_2', -->
<!--                          'reward_stim_1', 'reward_stim_2', 'comp_number', 'choice', 'choice_prob', -->
<!--                          'v_stim_1', 'v_stim_2', 'v_stim_3', -->
<!--                          'pe_stim_1', 'pe_stim_2', 'pe_stim_3', -->
<!--                          'fpe_stim_1', 'fpe_stim_2', 'fpe_stim_3') -->
<!-- # Sort after participants -->
<!-- data_model = data_model[order(data_model$sub_id),] -->
<!-- ``` -->

<!-- - Plot results of choice model -->

<!-- ```{r, out.width='100%'} -->
<!-- data_plot = data_model[,1:12] -->
<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'stim_1', -->
<!--                                       'stim_2', -->
<!--                                       'reward_stim_1', -->
<!--                                       'reward_stim_2', -->
<!--                                       'choice', -->
<!--                                       'choice_prob', -->
<!--                                       'comp_number')) -->
<!-- # Select only choices of stim 1 to calculate mean value (leaving out plateaus) -->
<!-- data_1 = subset(data_plot, choice == 1 & variable == 'v_stim_1') -->
<!-- # Calculate mean value of dist 1 WHEN CHOSEN -->
<!-- mean_1 = mean(data_1$value, na.rm = TRUE) -->

<!-- # Same for 2 -->
<!-- data_2 = subset(data_plot, choice == 2 & variable == 'v_stim_2') -->
<!-- mean_2 = mean(data_2$value, na.rm = TRUE) -->

<!-- # Same for 3 -->
<!-- data_3 = subset(data_plot, choice == 3 & variable == 'v_stim_3') -->
<!-- mean_3 = mean(data_3$value, na.rm = TRUE) -->

<!-- # Average over all subjects -->
<!-- data_plot = ddply(data_plot, -->
<!--                   .(trial, variable), -->
<!--                   summarize, -->
<!--                   mean_value = mean(value), -->
<!--                   sd_value = sd(value)) -->

<!-- # Plot model values -->
<!-- p = ggplot(data=data_plot, aes(x=trial, y=mean_value, group=variable, color=variable)) + -->
<!--   geom_hline(yintercept=c(1/3*100, 50, 2/3*100), linetype='dashed') + -->
<!--   geom_hline(yintercept=c(mean_1, -->
<!--                           mean_2, -->
<!--                           mean_3), -->
<!--              color=c(color$gain, color$gaussian, color$loss)) + -->
<!--   geom_line(size=1, alpha=0.8) + -->
<!--   scale_color_manual(values = c(color$gain, color$gaussian, color$loss)) + -->
<!--   labs(title=paste('Choice model performance (α0=', alpha0, ', α1=', alpha1, ', τ=', temperature, ')', sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') -->
<!-- p = ggplotly(p) -->

<!-- p -->
<!-- ``` -->

<!-- ## Greedy choice -->

<!-- ```{r} -->
<!-- # Set up matrix to store data in (to append subjects) -->
<!-- data_model = data.frame(matrix(0,0,18)) -->

<!-- # Loop over each subject -->
<!-- for(sub_count in subjects){ -->

<!--   set.seed(sub_count) -->

<!--   # Simulate data for subject -->
<!--   design = Create_design_var_forced(n_miniblocks, -->
<!--                                     perc_forced, -->
<!--                                     beta_a_le, beta_b_le, -->
<!--                                     gaussian_mean, gaussian_sd, -->
<!--                                     beta_a_ue, beta_b_ue, -->
<!--                                     two_betas = TRUE, -->
<!--                                     reward_space_lb, reward_space_ub) -->

<!--   # Create matrix to store data for each subject -->
<!--   results = data.frame(matrix(0,nrow(design),ncol(data_model))) -->
<!--   results[,1] = subjects[sub_count] -->
<!--   results[,2] = c(1:nrow(design)) -->
<!--   results[,3] = design$option_left -->
<!--   results[,4] = design$option_right -->
<!--   results[,5] = design$reward_stim_1 -->
<!--   results[,6] = design$reward_stim_2 -->
<!--   results[,7] = design$comp_number -->

<!--   # Run model over simulated data -->
<!--   sim = Pedlr(design, alpha0, alpha1, temperature, reward_space_ub, 'greedy') -->

<!--   # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--   results[,8] = sim$choices$choice -->
<!--   results[,9] = sim$choices$choice_prob -->
<!--   results[,10:12] = sim$values -->
<!--   results[,13:15] = sim$PE -->
<!--   results[,16:18] = sim$fPE -->

<!--   # Append all subjects -->
<!--   data_model = rbind(data_model, results) -->
<!-- } -->

<!-- # Convert to data frame (How our data will look like in the study) -->
<!-- data_model = data.frame(data_model) -->
<!-- colnames(data_model) = c('sub_id', 'trial', 'stim_1', 'stim_2', -->
<!--                          'reward_stim_1', 'reward_stim_2', 'comp_number', 'choice', 'choice_prob', -->
<!--                          'v_stim_1', 'v_stim_2', 'v_stim_3', -->
<!--                          'pe_stim_1', 'pe_stim_2', 'pe_stim_3', -->
<!--                          'fpe_stim_1', 'fpe_stim_2', 'fpe_stim_3') -->
<!-- # Sort after participants -->
<!-- data_model = data_model[order(data_model$sub_id),] -->
<!-- ``` -->

<!-- - Plot results of choice model -->

<!-- ```{r, out.width='100%'} -->
<!-- data_plot = data_model[,1:12] -->
<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'stim_1', -->
<!--                                       'stim_2', -->
<!--                                       'reward_stim_1', -->
<!--                                       'reward_stim_2', -->
<!--                                       'choice', -->
<!--                                       'choice_prob', -->
<!--                                       'comp_number')) -->
<!-- # Select only choices of stim 1 to calculate mean value (leaving out plateaus) -->
<!-- data_1 = subset(data_plot, choice == 1 & variable == 'v_stim_1') -->
<!-- # Calculate mean value of dist 1 WHEN CHOSEN -->
<!-- mean_1 = mean(data_1$value, na.rm = TRUE) -->

<!-- # Same for 2 -->
<!-- data_2 = subset(data_plot, choice == 2 & variable == 'v_stim_2') -->
<!-- mean_2 = mean(data_2$value, na.rm = TRUE) -->

<!-- # Same for 3 -->
<!-- data_3 = subset(data_plot, choice == 3 & variable == 'v_stim_3') -->
<!-- mean_3 = mean(data_3$value, na.rm = TRUE) -->

<!-- # Average over all subjects -->
<!-- data_plot = ddply(data_plot, -->
<!--                   .(trial, variable), -->
<!--                   summarize, -->
<!--                   mean_value = mean(value), -->
<!--                   sd_value = sd(value)) -->

<!-- # Plot model values -->
<!-- p = ggplot(data=data_plot, aes(x=trial, y=mean_value, group=variable, color=variable)) + -->
<!--   geom_hline(yintercept=c(1/3*100, 50, 2/3*100), linetype='dashed') + -->
<!--   geom_hline(yintercept=c(mean_1, -->
<!--                           mean_2, -->
<!--                           mean_3), -->
<!--              color=c(color$gain, color$gaussian, color$loss)) + -->
<!--   geom_line(size=1, alpha=0.8) + -->
<!--   scale_color_manual(values = c(color$gain, color$gaussian, color$loss)) + -->
<!--   labs(title=paste('Choice model performance (α0=', alpha0, ', α1=', alpha1, ', τ=', temperature, ')', sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') -->
<!-- p = ggplotly(p) -->

<!-- p -->
<!-- ``` -->

<!-- --- -->

<!-- # a0 and a1 decoupled model -->

<!-- Additional parameter handely contribution of different LR components. For now we fix the parameter to 0.5  -->
<!-- (equal influence). -->

<!-- ```{r} -->
<!-- interdep = 0.5 -->
<!-- ``` -->

<!-- ## Softmax choice -->

<!-- ```{r} -->
<!-- # Set up matrix to store data in (to append subjects) -->
<!-- data_model = data.frame(matrix(0,0,18)) -->

<!-- # Loop over each subject -->
<!-- for(sub_count in subjects){ -->

<!--   set.seed(sub_count) -->

<!--   # Simulate data for subject -->
<!--   design = Create_design_var_forced(n_miniblocks, -->
<!--                                     perc_forced, -->
<!--                                     beta_a_le, beta_b_le, -->
<!--                                     gaussian_mean, gaussian_sd, -->
<!--                                     beta_a_ue, beta_b_ue, -->
<!--                                     two_betas = TRUE, -->
<!--                                     reward_space_lb, reward_space_ub) -->

<!--   # Create matrix to store data for each subject -->
<!--   results = data.frame(matrix(0,nrow(design),ncol(data_model))) -->
<!--   results[,1] = subjects[sub_count] -->
<!--   results[,2] = c(1:nrow(design)) -->
<!--   results[,3] = design$option_left -->
<!--   results[,4] = design$option_right -->
<!--   results[,5] = design$reward_stim_1 -->
<!--   results[,6] = design$reward_stim_2 -->
<!--   results[,7] = design$comp_number -->

<!--   # Run model over simulated data -->
<!--   sim = Pedlr_interdep(design, -->
<!--                                         alpha0, -->
<!--                                         alpha1, -->
<!--                                         interdep, -->
<!--                                         temperature, -->
<!--                                         reward_space_ub, -->
<!--                                         'softmax') -->
<!--   # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--   results[,8] = sim$choices$choice -->
<!--   results[,9] = sim$choices$choice_prob -->
<!--   results[,10:12] = sim$values -->
<!--   results[,13:15] = sim$PE -->
<!--   results[,16:18] = sim$fPE -->

<!--   # Append all subjects -->
<!--   data_model = rbind(data_model, results) -->
<!-- } -->

<!-- # Convert to data frame (How our data will look like in the study) -->
<!-- data_model = data.frame(data_model) -->
<!-- colnames(data_model) = c('sub_id', 'trial', 'stim_1', 'stim_2', -->
<!--                          'reward_stim_1', 'reward_stim_2', 'comp_number', 'choice', 'choice_prob', -->
<!--                          'v_stim_1', 'v_stim_2', 'v_stim_3', -->
<!--                          'pe_stim_1', 'pe_stim_2', 'pe_stim_3', -->
<!--                          'fpe_stim_1', 'fpe_stim_2', 'fpe_stim_3') -->
<!-- # Sort after participants -->
<!-- data_model = data_model[order(data_model$sub_id),] -->
<!-- ``` -->

<!-- - Plot results of choice model -->

<!-- ```{r, out.width='100%'} -->
<!-- data_plot = data_model[,1:12] -->
<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'stim_1', -->
<!--                                       'stim_2', -->
<!--                                       'reward_stim_1', -->
<!--                                       'reward_stim_2', -->
<!--                                       'choice', -->
<!--                                       'choice_prob', -->
<!--                                       'comp_number')) -->
<!-- # Select only choices of stim 1 to calculate mean value (leaving out plateaus) -->
<!-- data_1 = subset(data_plot, choice == 1 & variable == 'v_stim_1') -->
<!-- # Calculate mean value of dist 1 WHEN CHOSEN -->
<!-- mean_1 = mean(data_1$value, na.rm = TRUE) -->

<!-- # Same for 2 -->
<!-- data_2 = subset(data_plot, choice == 2 & variable == 'v_stim_2') -->
<!-- mean_2 = mean(data_2$value, na.rm = TRUE) -->

<!-- # Same for 3 -->
<!-- data_3 = subset(data_plot, choice == 3 & variable == 'v_stim_3') -->
<!-- mean_3 = mean(data_3$value, na.rm = TRUE) -->

<!-- # Average over all subjects -->
<!-- data_plot = ddply(data_plot, -->
<!--                   .(trial, variable), -->
<!--                   summarize, -->
<!--                   mean_value = mean(value), -->
<!--                   sd_value = sd(value)) -->

<!-- # Plot model values -->
<!-- p = ggplot(data=data_plot, aes(x=trial, y=mean_value, group=variable, color=variable)) + -->
<!--   geom_hline(yintercept=c(1/3*100, 50, 2/3*100), linetype='dashed') + -->
<!--   geom_hline(yintercept=c(mean_1, -->
<!--                           mean_2, -->
<!--                           mean_3), -->
<!--              color=c(color$gain, color$gaussian, color$loss)) + -->
<!--   geom_line(size=1, alpha=0.8) + -->
<!--   scale_color_manual(values = c(color$gain, color$gaussian, color$loss)) + -->
<!--   labs(title=paste('Choice model performance (α0=', -->
<!--                    alpha0, -->
<!--                    ', α1=', -->
<!--                    alpha1, -->
<!--                    ', τ=', -->
<!--                    temperature, -->
<!--                    ', π=', -->
<!--                    interdep, -->
<!--                    ')', -->
<!--                    sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') -->
<!-- p = ggplotly(p) -->

<!-- p -->
<!-- ``` -->

<!-- --- -->

<!-- # Beta position swap -->

<!-- - Swap position of betas -->

<!-- ```{r} -->
<!-- # Set up matrix to store data in (to append subjects) -->
<!-- data_model = data.frame(matrix(0,0,18)) -->

<!-- # Loop over each subject -->
<!-- for(sub_count in subjects){ -->

<!--   set.seed(sub_count) -->

<!--   # Simulate data for subject -->
<!--   design = Create_design_var_forced(n_miniblocks, -->
<!--                                     perc_forced, -->
<!--                                     beta_a_le, beta_b_le, -->
<!--                                     gaussian_mean, gaussian_sd, -->
<!--                                     beta_a_ue, beta_b_ue, -->
<!--                                     two_betas = TRUE, -->
<!--                                     reward_space_lb, reward_space_ub) -->
<!--   # Switch positions of distributions (gain beta on UE, loss beta on LE) -->
<!--   # Gain beta -->
<!--   reward_index_left = which(design$option_left == 1) -->
<!--   design$reward_stim_1[reward_index_left] = design$reward_stim_1[reward_index_left] + 33 -->
<!--   design$reward_stim_1[which(design$reward_stim_1 >= 100)] = 100 -->
<!--   reward_index_right = which(design$option_right == 1) -->
<!--   design$reward_stim_2[reward_index_right] = design$reward_stim_2[reward_index_right] + 33 -->
<!--   design$reward_stim_2[which(design$reward_stim_2 >= 100)] = 100 -->
<!--   # Loss beta -->
<!--   reward_index_left = which(design$option_left == 3) -->
<!--   design$reward_stim_1[reward_index_left] = design$reward_stim_1[reward_index_left] - 33 -->
<!--   design$reward_stim_1[which(design$reward_stim_1 <= 1)] = 1 -->
<!--   reward_index_right = which(design$option_right == 3) -->
<!--   design$reward_stim_2[reward_index_right] = design$reward_stim_2[reward_index_right] - 33 -->
<!--   design$reward_stim_2[which(design$reward_stim_2 <= 1)] = 1 -->

<!--   # Create matrix to store data for each subject -->
<!--   results = data.frame(matrix(0,nrow(design),ncol(data_model))) -->
<!--   results[,1] = subjects[sub_count] -->
<!--   results[,2] = c(1:nrow(design)) -->
<!--   results[,3] = design$option_left -->
<!--   results[,4] = design$option_right -->
<!--   results[,5] = design$reward_stim_1 -->
<!--   results[,6] = design$reward_stim_2 -->
<!--   results[,7] = design$comp_number -->

<!--   # Run model over simulated data -->
<!--   sim = Pedlr_interdep(design, -->
<!--                                         alpha0, -->
<!--                                         alpha1, -->
<!--                                         interdep, -->
<!--                                         temperature, -->
<!--                                         reward_space_ub, -->
<!--                                         'softmax') -->
<!--   # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--   results[,8] = sim$choices$choice -->
<!--   results[,9] = sim$choices$choice_prob -->
<!--   results[,10:12] = sim$values -->
<!--   results[,13:15] = sim$PE -->
<!--   results[,16:18] = sim$fPE -->

<!--   # Append all subjects -->
<!--   data_model = rbind(data_model, results) -->
<!-- } -->

<!-- # Convert to data frame (How our data will look like in the study) -->
<!-- data_model = data.frame(data_model) -->
<!-- colnames(data_model) = c('sub_id', 'trial', 'stim_1', 'stim_2', -->
<!--                          'reward_stim_1', 'reward_stim_2', 'comp_number', 'choice', 'choice_prob', -->
<!--                          'v_stim_1', 'v_stim_2', 'v_stim_3', -->
<!--                          'pe_stim_1', 'pe_stim_2', 'pe_stim_3', -->
<!--                          'fpe_stim_1', 'fpe_stim_2', 'fpe_stim_3') -->
<!-- # Sort after participants -->
<!-- data_model = data_model[order(data_model$sub_id),] -->
<!-- ``` -->

<!-- - Histograms of switched gain/loss betas -->

<!-- ```{r out.width='100%', message=FALSE} -->
<!-- gain_samples = c(subset(data_model, 'stim_1' != 'stim_2')$reward_stim_1[subset(data_model, 'stim_1' != 'stim_2')$stim_1 == 1], -->
<!--                  subset(data_model, 'stim_1' != 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' != 'stim_2')$stim_2 == 1], -->
<!--                  subset(data_model, 'stim_1' == 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' == 'stim_2')$stim_1 == 1]) -->

<!-- loss_samples = c(subset(data_model, 'stim_1' != 'stim_2')$reward_stim_1[subset(data_model, 'stim_1' != 'stim_2')$stim_1 == 3], -->
<!--                  subset(data_model, 'stim_1' != 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' != 'stim_2')$stim_2 == 3], -->
<!--                  subset(data_model, 'stim_1' == 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' == 'stim_2')$stim_1 == 3]) -->

<!-- gauss_samples = c(subset(data_model, 'stim_1' != 'stim_2')$reward_stim_1[subset(data_model, 'stim_1' != 'stim_2')$stim_1 == 2], -->
<!--                   subset(data_model, 'stim_1' != 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' != 'stim_2')$stim_2 == 2], -->
<!--                   subset(data_model, 'stim_1' == 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' == 'stim_2')$stim_1 == 2]) -->

<!-- data_sampling = data.frame(matrix(NA, length(gain_samples), 3)) -->
<!-- colnames(data_sampling) = c('stim_1', 'stim_2', 'stim_3') -->
<!-- data_sampling$stim_1 = gain_samples -->
<!-- data_sampling$stim_2 = gauss_samples -->
<!-- data_sampling$stim_3 = loss_samples -->
<!-- data_sampling = melt(data_sampling) -->

<!-- # Plot histograms -->
<!-- p_sampling = ggplot(data=data_sampling, aes(x=value, fill=variable)) + -->
<!--   scale_fill_manual(values = c(color$gain, color$gaussian, color$loss)) + -->
<!--   geom_histogram(binwidth = 1) + -->
<!--   facet_wrap(~variable) -->

<!-- ggplotly(p_sampling) -->
<!-- ``` -->

<!-- The gain and loss beta distributions are now on the swapped ends of the reward space. If this would switch the -->
<!-- bias we would know its due to the position and maybe the undersampling. -->

<!-- - Plot results -->

<!-- ```{r, out.width='100%'} -->
<!-- data_plot = data_model[,1:12] -->
<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'stim_1', -->
<!--                                       'stim_2', -->
<!--                                       'reward_stim_1', -->
<!--                                       'reward_stim_2', -->
<!--                                       'choice', -->
<!--                                       'choice_prob', -->
<!--                                       'comp_number')) -->
<!-- # Select only choices of stim 1 to calculate mean value (leaving out plateaus) -->
<!-- data_1 = subset(data_plot, choice == 1 & variable == 'v_stim_1') -->
<!-- # Calculate mean value of dist 1 WHEN CHOSEN -->
<!-- mean_1 = mean(data_1$value, na.rm = TRUE) -->

<!-- # Same for 2 -->
<!-- data_2 = subset(data_plot, choice == 2 & variable == 'v_stim_2') -->
<!-- mean_2 = mean(data_2$value, na.rm = TRUE) -->

<!-- # Same for 3 -->
<!-- data_3 = subset(data_plot, choice == 3 & variable == 'v_stim_3') -->
<!-- mean_3 = mean(data_3$value, na.rm = TRUE) -->

<!-- # Average over all subjects -->
<!-- data_plot = ddply(data_plot, -->
<!--                   .(trial, variable), -->
<!--                   summarize, -->
<!--                   mean_value = mean(value), -->
<!--                   sd_value = sd(value)) -->

<!-- # Plot model values -->
<!-- p = ggplot(data=data_plot, aes(x=trial, y=mean_value, group=variable, color=variable)) + -->
<!--   geom_hline(yintercept=c(1/3*100, 50, 2/3*100), linetype='dashed') + -->
<!--   geom_hline(yintercept=c(mean_1, -->
<!--                           mean_2, -->
<!--                           mean_3), -->
<!--              color=c(color$gain, color$gaussian, color$loss)) + -->
<!--   geom_line(size=1, alpha=0.8) + -->
<!--   scale_color_manual(values = c(color$gain, color$gaussian, color$loss)) + -->
<!--   labs(title=paste('Choice model performance (α0=', alpha0, ', α1=', alpha1, ', τ=', temperature, ')', sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') -->
<!-- p = ggplotly(p) -->

<!-- p -->
<!-- ``` -->

<!-- The stimuli changed position but the bias pattern stayed the same. The bias does not swap for the loss beta, -->
<!-- even if it is posted to the lower end. Same for the gain beta. -->

<!-- # Three Gaussians -->

<!-- - Simulate data -->

<!-- ```{r} -->
<!-- # Set up matrix to store data in (to append subjects) -->
<!-- data_model = data.frame(matrix(0,0,18)) -->

<!-- # Loop over each subject -->
<!-- for(sub_count in subjects){ -->

<!--   set.seed(sub_count) -->

<!--   # Simulate data for subject -->
<!--   design = Create_design_var_forced(n_miniblocks, -->
<!--                                     perc_forced, -->
<!--                                     beta_a_le, beta_b_le, -->
<!--                                     gaussian_mean, gaussian_sd, -->
<!--                                     beta_a_ue, beta_b_ue, -->
<!--                                     two_betas = TRUE, -->
<!--                                     reward_space_lb, reward_space_ub) -->
<!--   # Resample beta distirbutions as Gaussians -->
<!--   # Gain beta -->
<!--   # Find gain beta comparisons -->
<!--   reward_index_left = which(design$option_left == 1) -->
<!--   reward_index_right = which(design$option_right == 1) -->
<!--   # Delete forced choices from comparisons to handle them separately -->
<!--   reward_index_forced = intersect(reward_index_left, reward_index_right) -->
<!--   reward_index_left = reward_index_left[!reward_index_left %in% reward_index_forced] -->
<!--   reward_index_right = reward_index_right[!reward_index_right %in% reward_index_forced] -->
<!--   # Sample as many rewards as needed from LE gaussian -->
<!--   replace = Gaussian_pseudo_sim(length(c(reward_index_left, reward_index_right, reward_index_forced)), -->
<!--                                 1/3 * 100, -->
<!--                                 gaussian_sd, -->
<!--                                 'gauss_ue', -->
<!--                                 0, -->
<!--                                 100) -->
<!--   # Replace rewards of gain beta -->
<!--   design$reward_stim_1[reward_index_left] = replace$outcome[1:length(reward_index_left)] -->
<!--   design$reward_stim_2[reward_index_right] = replace$outcome[(length(reward_index_left)+1):(length(reward_index_right)+length(reward_index_left))] -->
<!--   # Forced choices are copied for both stimuli -->
<!--   design$reward_stim_1[reward_index_forced] = replace$outcome[(length(reward_index_right)+ -->
<!--                                                                  length(reward_index_left)+1):( -->
<!--                                                                    length(reward_index_right)+ -->
<!--                                                                      length(reward_index_left)+ -->
<!--                                                                 length(reward_index_forced))] -->
<!--   design$reward_stim_2[reward_index_forced] = design$reward_stim_1[reward_index_forced] -->

<!--   # Loss beta -->
<!--   reward_index_left = which(design$option_left == 3) -->
<!--   reward_index_right = which(design$option_right == 3) -->
<!--   # Delete forced choices from comparisons to handle them separately -->
<!--   reward_index_forced = intersect(reward_index_left, reward_index_right) -->
<!--   reward_index_left = reward_index_left[!reward_index_left %in% reward_index_forced] -->
<!--   reward_index_right = reward_index_right[!reward_index_right %in% reward_index_forced] -->
<!--   # Sample as many rewards as needed from LE gaussian -->
<!--   replace = Gaussian_pseudo_sim(length(c(reward_index_left, reward_index_right, reward_index_forced)), -->
<!--                                 2/3 * 100, -->
<!--                                 gaussian_sd, -->
<!--                                 'gauss_ue', -->
<!--                                 0, -->
<!--                                 100) -->
<!--   # Replace rewards of gain beta -->
<!--   # Replace rewards of gain beta -->
<!--   design$reward_stim_1[reward_index_left] = replace$outcome[1:length(reward_index_left)] -->
<!--   design$reward_stim_2[reward_index_right] = replace$outcome[(length(reward_index_left)+1):(length(reward_index_right)+length(reward_index_left))] -->
<!--   # Forced choices are copied for both stimuli -->
<!--   design$reward_stim_1[reward_index_forced] = replace$outcome[(length(reward_index_right)+ -->
<!--                                                                  length(reward_index_left)+1):( -->
<!--                                                                    length(reward_index_right)+ -->
<!--                                                                      length(reward_index_left)+ -->
<!--                                                                 length(reward_index_forced))] -->
<!--   design$reward_stim_2[reward_index_forced] = design$reward_stim_1[reward_index_forced] -->

<!--   # Create matrix to store data for each subject -->
<!--   results = data.frame(matrix(0,nrow(design),ncol(data_model))) -->
<!--   results[,1] = subjects[sub_count] -->
<!--   results[,2] = c(1:nrow(design)) -->
<!--   results[,3] = design$option_left -->
<!--   results[,4] = design$option_right -->
<!--   results[,5] = design$reward_stim_1 -->
<!--   results[,6] = design$reward_stim_2 -->
<!--   results[,7] = design$comp_number -->

<!--   # Run model over simulated data -->
<!--   sim = Pedlr_interdep(design, -->
<!--                                         alpha0, -->
<!--                                         alpha1, -->
<!--                                         interdep, -->
<!--                                         temperature, -->
<!--                                         reward_space_ub, -->
<!--                                         'softmax') -->
<!--   # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--   results[,8] = sim$choices$choice -->
<!--   results[,9] = sim$choices$choice_prob -->
<!--   results[,10:12] = sim$values -->
<!--   results[,13:15] = sim$PE -->
<!--   results[,16:18] = sim$fPE -->

<!--   # Append all subjects -->
<!--   data_model = rbind(data_model, results) -->
<!-- } -->

<!-- # Convert to data frame (How our data will look like in the study) -->
<!-- data_model = data.frame(data_model) -->
<!-- colnames(data_model) = c('sub_id', 'trial', 'stim_1', 'stim_2', -->
<!--                          'reward_stim_1', 'reward_stim_2', 'comp_number', 'choice', 'choice_prob', -->
<!--                          'v_stim_1', 'v_stim_2', 'v_stim_3', -->
<!--                          'pe_stim_1', 'pe_stim_2', 'pe_stim_3', -->
<!--                          'fpe_stim_1', 'fpe_stim_2', 'fpe_stim_3') -->
<!-- # Sort after participants -->
<!-- data_model = data_model[order(data_model$sub_id),] -->
<!-- ``` -->

<!-- - Histogram -->

<!-- ```{r out.width='100%', message=FALSE} -->
<!-- gain_samples = c(subset(data_model, 'stim_1' != 'stim_2')$reward_stim_1[subset(data_model, 'stim_1' != 'stim_2')$stim_1 == 1], -->
<!--                  subset(data_model, 'stim_1' != 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' != 'stim_2')$stim_2 == 1], -->
<!--                  subset(data_model, 'stim_1' == 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' == 'stim_2')$stim_1 == 1]) -->

<!-- loss_samples = c(subset(data_model, 'stim_1' != 'stim_2')$reward_stim_1[subset(data_model, 'stim_1' != 'stim_2')$stim_1 == 3], -->
<!--                  subset(data_model, 'stim_1' != 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' != 'stim_2')$stim_2 == 3], -->
<!--                  subset(data_model, 'stim_1' == 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' == 'stim_2')$stim_1 == 3]) -->

<!-- gauss_samples = c(subset(data_model, 'stim_1' != 'stim_2')$reward_stim_1[subset(data_model, 'stim_1' != 'stim_2')$stim_1 == 2], -->
<!--                   subset(data_model, 'stim_1' != 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' != 'stim_2')$stim_2 == 2], -->
<!--                   subset(data_model, 'stim_1' == 'stim_2')$reward_stim_2[subset(data_model, 'stim_1' == 'stim_2')$stim_1 == 2]) -->

<!-- data_sampling = data.frame(matrix(NA, length(gain_samples), 3)) -->
<!-- colnames(data_sampling) = c('stim_1', 'stim_2', 'stim_3') -->
<!-- data_sampling$stim_1 = gain_samples -->
<!-- data_sampling$stim_2 = gauss_samples -->
<!-- data_sampling$stim_3 = loss_samples -->
<!-- data_sampling = melt(data_sampling) -->

<!-- # Plot histograms -->
<!-- p_sampling = ggplot(data=data_sampling, aes(x=value, fill=variable)) + -->
<!--   scale_fill_brewer(palette = 'Accent') + -->
<!--   geom_histogram(binwidth = 1) + -->
<!--   facet_wrap(~variable) -->

<!-- ggplotly(p_sampling) -->
<!-- ``` -->

<!-- - Plot results -->

<!-- ```{r, out.width='100%'} -->
<!-- data_plot = data_model[,1:12] -->
<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'stim_1', -->
<!--                                       'stim_2', -->
<!--                                       'reward_stim_1', -->
<!--                                       'reward_stim_2', -->
<!--                                       'choice', -->
<!--                                       'choice_prob', -->
<!--                                       'comp_number')) -->
<!-- # Select only choices of stim 1 to calculate mean value (leaving out plateaus) -->
<!-- data_1 = subset(data_plot, choice == 1 & variable == 'v_stim_1') -->
<!-- # Calculate mean value of dist 1 WHEN CHOSEN -->
<!-- mean_1 = mean(data_1$value, na.rm = TRUE) -->

<!-- # Same for 2 -->
<!-- data_2 = subset(data_plot, choice == 2 & variable == 'v_stim_2') -->
<!-- mean_2 = mean(data_2$value, na.rm = TRUE) -->

<!-- # Same for 3 -->
<!-- data_3 = subset(data_plot, choice == 3 & variable == 'v_stim_3') -->
<!-- mean_3 = mean(data_3$value, na.rm = TRUE) -->

<!-- # Average over all subjects -->
<!-- data_plot = ddply(data_plot, -->
<!--                   .(trial, variable), -->
<!--                   summarize, -->
<!--                   mean_value = mean(value), -->
<!--                   sd_value = sd(value)) -->

<!-- # Plot model values -->
<!-- p = ggplot(data=data_plot, aes(x=trial, y=mean_value, group=variable, color=variable)) + -->
<!--   geom_hline(yintercept=c(1/3*100, 50, 2/3*100), linetype='dashed') + -->
<!--   geom_hline(yintercept=c(mean_1, -->
<!--                           mean_2, -->
<!--                           mean_3), -->
<!--              color=c(color$gain, color$gaussian, color$loss)) + -->
<!--   geom_line(size=1, alpha=0.8) + -->
<!--   scale_color_manual(values = c(color$gain, color$gaussian, color$loss)) + -->
<!--   labs(title=paste('Choice model performance (α0=', -->
<!--                    alpha0, -->
<!--                    ', α1=', -->
<!--                    alpha1, -->
<!--                    ', τ=', -->
<!--                    temperature, -->
<!--                    ', π=', -->
<!--                    interdep, -->
<!--                    ')', -->
<!--                    sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') -->
<!-- p = ggplotly(p) -->

<!-- p -->
<!-- ``` -->

<!-- --- -->

<!-- # Single beta -->

<!-- ## Gain beta -->

<!-- - Simulate data -->

<!-- ```{r echo=FALSE} -->
<!-- # Set up matrix to store data in (to append subjects) -->
<!-- data_model = data.frame(matrix(0,0,18)) -->

<!-- # Loop over each subject -->
<!-- for(sub_count in subjects){ -->

<!--   set.seed(sub_count) -->

<!--   # Simulate data for subject -->
<!--   design = Create_design_var_forced(n_miniblocks, -->
<!--                                     perc_forced, -->
<!--                                     1/6*100, gaussian_sd, -->
<!--                                     beta_a_le, beta_b_le, -->
<!--                                     3/6*100, gaussian_sd, -->
<!--                                     two_betas = FALSE, -->
<!--                                     reward_space_lb, reward_space_ub) -->

<!--   # Create matrix to store data for each subject -->
<!--   results = data.frame(matrix(0,nrow(design),ncol(data_model))) -->
<!--   results[,1] = subjects[sub_count] -->
<!--   results[,2] = c(1:nrow(design)) -->
<!--   results[,3] = design$option_left -->
<!--   results[,4] = design$option_right -->
<!--   results[,5] = design$reward_stim_1 -->
<!--   results[,6] = design$reward_stim_2 -->
<!--   results[,7] = design$comp_number -->

<!--   # Run model over simulated data -->
<!--   sim = Pedlr_interdep(design, -->
<!--                                         alpha0, -->
<!--                                         alpha1, -->
<!--                                         interdep, -->
<!--                                         temperature, -->
<!--                                         reward_space_ub, -->
<!--                                         'softmax') -->
<!--   # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--   results[,8] = sim$choices$choice -->
<!--   results[,9] = sim$choices$choice_prob -->
<!--   results[,10:12] = sim$values -->
<!--   results[,13:15] = sim$PE -->
<!--   results[,16:18] = sim$fPE -->

<!--   # Append all subjects -->
<!--   data_model = rbind(data_model, results) -->
<!-- } -->

<!-- # Convert to data frame (How our data will look like in the study) -->
<!-- data_model = data.frame(data_model) -->
<!-- colnames(data_model) = c('sub_id', 'trial', 'stim_1', 'stim_2', -->
<!--                          'reward_stim_1', 'reward_stim_2', 'comp_number', 'choice', 'choice_prob', -->
<!--                          'v_stim_1', 'v_stim_2', 'v_stim_3', -->
<!--                          'pe_stim_1', 'pe_stim_2', 'pe_stim_3', -->
<!--                          'fpe_stim_1', 'fpe_stim_2', 'fpe_stim_3') -->
<!-- # Sort after participants -->
<!-- data_model = data_model[order(data_model$sub_id),] -->
<!-- ``` -->

<!-- - Plot results of choice model -->

<!-- ```{r, out.width='100%'} -->
<!-- data_plot = data_model[,1:12] -->
<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'stim_1', -->
<!--                                       'stim_2', -->
<!--                                       'reward_stim_1', -->
<!--                                       'reward_stim_2', -->
<!--                                       'choice', -->
<!--                                       'choice_prob', -->
<!--                                       'comp_number')) -->
<!-- # Select only choices of stim 1 to calculate mean value (leaving out plateaus) -->
<!-- data_1 = subset(data_plot, choice == 1 & variable == 'v_stim_1') -->
<!-- # Calculate mean value of dist 1 WHEN CHOSEN -->
<!-- mean_1 = mean(data_1$value, na.rm = TRUE) -->

<!-- # Same for 2 -->
<!-- data_2 = subset(data_plot, choice == 2 & variable == 'v_stim_2') -->
<!-- mean_2 = mean(data_2$value, na.rm = TRUE) -->

<!-- # Same for 3 -->
<!-- data_3 = subset(data_plot, choice == 3 & variable == 'v_stim_3') -->
<!-- mean_3 = mean(data_3$value, na.rm = TRUE) -->

<!-- # Average over all subjects -->
<!-- data_plot = ddply(data_plot, -->
<!--                   .(trial, variable), -->
<!--                   summarize, -->
<!--                   mean_value = mean(value), -->
<!--                   sd_value = sd (value)) -->

<!-- # Plot model values -->
<!-- p = ggplot(data=data_plot, aes(x=trial, y=mean_value, group=variable, color=variable)) + -->
<!--   geom_hline(yintercept=c(1/6*100, 2/6*100, 50), linetype='dashed') + -->
<!--   geom_hline(yintercept=c(mean_1, -->
<!--                           mean_2, -->
<!--                           mean_3), -->
<!--              color=c(color$gaussian, color$gain, color$gaussian)) + -->
<!--   geom_line(size=1, alpha=0.8) + -->
<!--   scale_color_manual(values = c(color$gaussian, color$gain, color$gaussian)) + -->
<!--   labs(title=paste('Choice model performance (α0=', -->
<!--                    alpha0, -->
<!--                    ', α1=', -->
<!--                    alpha1, -->
<!--                    ', τ=', -->
<!--                    temperature, -->
<!--                    ', π=', -->
<!--                    interdep, -->
<!--                    ')', -->
<!--                    sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') -->
<!-- p = ggplotly(p) -->

<!-- p -->
<!-- ``` -->

<!-- ## Loss beta -->

<!-- - Simulate data -->

<!-- ```{r echo=FALSE} -->
<!-- # Define simulation parameters -->
<!-- n_subjects = 40 -->
<!-- subjects = c(1:n_subjects) -->
<!-- n_miniblocks = 25 -->

<!-- # Set up matrix to store data in (to append subjects) -->
<!-- data_model = data.frame(matrix(0,0,18)) -->

<!-- # Loop over each subject -->
<!-- for(sub_count in subjects){ -->

<!--   set.seed(sub_count) -->

<!--   # Simulate data for subject -->
<!--   design = Create_design_var_forced(n_miniblocks, -->
<!--                                     perc_forced, -->
<!--                                     3/6*100, gaussian_sd, -->
<!--                                     beta_a_ue, beta_b_ue, -->
<!--                                     5/6*100, gaussian_sd, -->
<!--                                     two_betas = FALSE, -->
<!--                                     reward_space_lb, reward_space_ub) -->

<!--   # Create matrix to store data for each subject -->
<!--   results = data.frame(matrix(0,nrow(design),ncol(data_model))) -->
<!--   results[,1] = subjects[sub_count] -->
<!--   results[,2] = c(1:nrow(design)) -->
<!--   results[,3] = design$option_left -->
<!--   results[,4] = design$option_right -->
<!--   results[,5] = design$reward_stim_1 -->
<!--   results[,6] = design$reward_stim_2 -->
<!--   results[,7] = design$comp_number -->

<!--   # Run model over simulated data -->
<!--   sim = Pedlr_interdep(design, -->
<!--                                         alpha0, -->
<!--                                         alpha1, -->
<!--                                         interdep, -->
<!--                                         temperature, -->
<!--                                         reward_space_ub, -->
<!--                                         'softmax') -->
<!--   # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--   results[,8] = sim$choices$choice -->
<!--   results[,9] = sim$choices$choice_prob -->
<!--   results[,10:12] = sim$values -->
<!--   results[,13:15] = sim$PE -->
<!--   results[,16:18] = sim$fPE -->

<!--   # Append all subjects -->
<!--   data_model = rbind(data_model, results) -->
<!-- } -->

<!-- # Convert to data frame (How our data will look like in the study) -->
<!-- data_model = data.frame(data_model) -->
<!-- colnames(data_model) = c('sub_id', 'trial', 'stim_1', 'stim_2', -->
<!--                          'reward_stim_1', 'reward_stim_2', 'comp_number', 'choice', 'choice_prob', -->
<!--                         'v_stim_1', 'v_stim_2', 'v_stim_3', -->
<!--                         'pe_stim_1', 'pe_stim_2', 'pe_stim_3', -->
<!--                         'fpe_stim_1', 'fpe_stim_2', 'fpe_stim_3') -->
<!-- # Sort after participants -->
<!-- data_model = data_model[order(data_model$sub_id),] -->
<!-- ``` -->

<!-- - Plot results -->

<!-- ```{r, out.width='100%'} -->
<!-- data_plot = data_model[,1:12] -->
<!-- data_plot = melt(data_plot, id.vars=c('sub_id', -->
<!--                                       'trial', -->
<!--                                       'stim_1', -->
<!--                                       'stim_2', -->
<!--                                       'reward_stim_1', -->
<!--                                       'reward_stim_2', -->
<!--                                       'choice', -->
<!--                                       'choice_prob', -->
<!--                                       'comp_number')) -->
<!-- # Select only choices of stim 1 to calculate mean value (leaving out plateaus) -->
<!-- data_1 = subset(data_plot, choice == 1 & variable == 'v_stim_1') -->
<!-- # Calculate mean value of dist 1 WHEN CHOSEN -->
<!-- mean_1 = mean(data_1$value, na.rm = TRUE) -->

<!-- # Same for 2 -->
<!-- data_2 = subset(data_plot, choice == 2 & variable == 'v_stim_2') -->
<!-- mean_2 = mean(data_2$value, na.rm = TRUE) -->

<!-- # Same for 3 -->
<!-- data_3 = subset(data_plot, choice == 3 & variable == 'v_stim_3') -->
<!-- mean_3 = mean(data_3$value, na.rm = TRUE) -->

<!-- # Average over all subjects -->
<!-- data_plot = ddply(data_plot, -->
<!--                   .(trial, variable), -->
<!--                   summarize, -->
<!--                   mean_value = mean(value), -->
<!--                   sd_value = sd (value)) -->

<!-- # Plot model values -->
<!-- p = ggplot(data=data_plot, aes(x=trial, y=mean_value, group=variable, color=variable)) + -->
<!--   geom_hline(yintercept=c(50, 4/6*100, 5/6*100), linetype='dashed') + -->
<!--   geom_hline(yintercept=c(mean_1, -->
<!--                           mean_2, -->
<!--                           mean_3), -->
<!--              color=c(color$gaussian, color$loss, color$gaussian)) + -->
<!--   geom_line(size=1, alpha=0.8) + -->
<!--   scale_color_manual(values = c(color$gaussian, color$loss, color$gaussian)) + -->
<!--   labs(title=paste('Choice model performance (α0=', -->
<!--                    alpha0, -->
<!--                    ', α1=', -->
<!--                    alpha1, -->
<!--                    ', τ=', -->
<!--                    temperature, -->
<!--                    ', π=', -->
<!--                    interdep, -->
<!--                    ')', -->
<!--                    sep=''), -->
<!--        x='Trial', -->
<!--        y='Estimated outcome', -->
<!--        color='Stimulus') -->
<!-- p = ggplotly(p) -->

<!-- p -->
<!-- ``` -->

<!-- --- -->

<!-- # Anaysis of PE -->

<!-- ## Gain beta -->

<!-- - No seed is set for this analysis, otherwise all samples had the same outcome. -->

<!-- ```{r} -->
<!-- # Number of samples for mean pe -->
<!-- i = 10 -->
<!-- pe_mean_gain = c(1:i) -->

<!-- for(i in 1:10){ -->
<!--   # Define simulation parameters -->
<!--   n_subjects = 40 -->
<!--   subjects = c(1:n_subjects) -->
<!--   n_miniblocks = 25 -->

<!--   # Set up matrix to store data in (to append subjects) -->
<!--   data_model = data.frame(matrix(0,0,18)) -->

<!--   # Loop over each subject -->
<!--   for(sub_count in subjects){ -->

<!--     # Simulate data for subject -->
<!--     design = Create_design_var_forced(n_miniblocks, -->
<!--                                       perc_forced, -->
<!--                                       1/6*100, gaussian_sd, -->
<!--                                       beta_a_le, beta_b_le, -->
<!--                                       3/6*100, gaussian_sd, -->
<!--                                       two_betas = FALSE, -->
<!--                                       reward_space_lb, reward_space_ub) -->

<!--     # Create matrix to store data for each subject -->
<!--     results = data.frame(matrix(0,nrow(design),ncol(data_model))) -->
<!--     results[,1] = subjects[sub_count] -->
<!--     results[,2] = c(1:nrow(design)) -->
<!--     results[,3] = design$option_left -->
<!--     results[,4] = design$option_right -->
<!--     results[,5] = design$reward_stim_1 -->
<!--     results[,6] = design$reward_stim_2 -->
<!--     results[,7] = design$comp_number -->

<!--     # Run model over simulated data -->
<!--     sim = Pedlr_interdep(design, -->
<!--                                         alpha0, -->
<!--                                         alpha1, -->
<!--                                         interdep, -->
<!--                                         temperature, -->
<!--                                         reward_space_ub, -->
<!--                                         'softmax') -->
<!--     # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--     results[,8] = sim$choices$choice -->
<!--     results[,9] = sim$choices$choice_prob -->
<!--     results[,10:12] = sim$values -->
<!--     results[,13:15] = sim$PE -->
<!--     results[,16:18] = sim$fPE -->

<!--     # Append all subjects -->
<!--     data_model = rbind(data_model, results) -->
<!--   } -->

<!--   # Convert to data frame (How our data will look like in the study) -->
<!--   data_model = data.frame(data_model) -->
<!--   colnames(data_model) = c('sub_id', 'trial', 'stim_1', 'stim_2', -->
<!--                            'reward_stim_1', 'reward_stim_2', 'comp_number', 'choice', 'choice_prob', -->
<!--                            'v_stim_1', 'v_stim_2', 'v_stim_3', -->
<!--                            'pe_stim_1', 'pe_stim_2', 'pe_stim_3', -->
<!--                            'fpe_stim_1', 'fpe_stim_2', 'fpe_stim_3') -->
<!--   # Sort after participants -->
<!--   data_model = data_model[order(data_model$sub_id),] -->

<!--   # PE analysis -->
<!--   pe_mean_gain[i] = mean(data_model$pe_stim_2[data_model$pe_stim_2 != 0], na.rm = TRUE) -->
<!-- } -->

<!-- pe_mean_gain -->
<!-- mean(pe_mean_gain) -->
<!-- ``` -->

<!-- Negative average PE in Gain beta -->

<!-- ## Loss beta -->

<!-- - No seed is set for this analysis, otherwise all samples had the same outcome. -->

<!-- ```{r} -->
<!-- # Number of samples for mean pe -->
<!-- i = 10 -->
<!-- pe_mean_loss = c(1:i) -->

<!-- for(i in 1:10){ -->
<!--   # Define simulation parameters -->
<!--   n_subjects = 40 -->
<!--   subjects = c(1:n_subjects) -->
<!--   n_miniblocks = 25 -->

<!--   # Set up matrix to store data in (to append subjects) -->
<!--   data_model = matrix(0,0,18) -->

<!--   # Loop over each subject -->
<!--   for(sub_count in subjects){ -->

<!--     # Simulate data for subject -->
<!--     design = Create_design_var_forced(n_miniblocks, -->
<!--                                       perc_forced, -->
<!--                                       3/6*100, gaussian_sd, -->
<!--                                       beta_a_ue, beta_b_ue, -->
<!--                                       5/6*100, gaussian_sd, -->
<!--                                       two_betas = FALSE, -->
<!--                                       reward_space_lb, reward_space_ub) -->

<!--     # Create matrix to store data for each subject -->
<!--     results = data.frame(matrix(0,nrow(design),ncol(data_model))) -->
<!--     results[,1] = subjects[sub_count] -->
<!--     results[,2] = c(1:nrow(design)) -->
<!--     results[,3] = design$option_left -->
<!--     results[,4] = design$option_right -->
<!--     results[,5] = design$reward_stim_1 -->
<!--     results[,6] = design$reward_stim_2 -->
<!--     results[,7] = design$comp_number -->

<!--     # Run model over simulated data -->
<!--     sim = Pedlr_interdep(design, -->
<!--                                         alpha0, -->
<!--                                         alpha1, -->
<!--                                         interdep, -->
<!--                                         temperature, -->
<!--                                         reward_space_ub, -->
<!--                                         'softmax') -->
<!--     # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--     results[,8] = sim$choices$choice -->
<!--     results[,9] = sim$choices$choice_prob -->
<!--     results[,10:12] = sim$values -->
<!--     results[,13:15] = sim$PE -->
<!--     results[,16:18] = sim$fPE -->

<!--     # Append all subjects -->
<!--     data_model = rbind(data_model, results) -->
<!--   } -->

<!--   # Convert to data frame (How our data will look like in the study) -->
<!--   data_model = data.frame(data_model) -->
<!--   colnames(data_model) = c('sub_id', 'trial', 'stim_1', 'stim_2', -->
<!--                            'reward_stim_1', 'reward_stim_2', 'comp_number', 'choice', 'choice_prob', -->
<!--                            'v_stim_1', 'v_stim_2', 'v_stim_3', -->
<!--                            'pe_stim_1', 'pe_stim_2', 'pe_stim_3', -->
<!--                            'fpe_stim_1', 'fpe_stim_2', 'fpe_stim_3') -->
<!--   # Sort after participants -->
<!--   data_model = data_model[order(data_model$sub_id),] -->

<!--   # PE analysis -->
<!--   pe_mean_loss[i] = mean(data_model$pe_stim_2[data_model$pe_stim_2 != 0], na.rm = TRUE) -->
<!-- } -->

<!-- pe_mean_loss -->
<!-- mean(pe_mean_loss) -->

<!-- ``` -->

<!-- Positive average PE in Loss beta -->

<!-- --- -->

<!-- # Parameter influence on bias -->

<!-- - Function to simulate number of participants with model and get bias -->

<!-- ```{r} -->
<!-- bias_extraction = function(n_subjects, -->
<!--                            n_miniblocks, -->
<!--                            perc_forced, -->
<!--                            two_betas, -->
<!--                            param1.le, param2.le, -->
<!--                            param1.mid, param2.mid, -->
<!--                            param1.ue, param2.ue, -->
<!--                            reward_space_lb, reward_space_ub, -->
<!--                            alpha0, alpha1, interdep, temperature, policy){ -->

<!--   # Form vector from number of participants -->
<!--   subjects = c(1:n_subjects) -->

<!--   # Set up matrix to store data in (to append subjects) -->
<!--   data_model = data.frame(matrix(0,0,18)) -->
<!--   # Loop over each subject -->
<!--   for(sub_count in subjects){ -->

<!--     set.seed(sub_count) -->

<!--     # Simulate data for subject -->
<!--     design = Create_design_var_forced(n_miniblocks, -->
<!--                                       perc_forced, -->
<!--                                       param1.le, param2.le, -->
<!--                                       param1.mid, param2.mid, -->
<!--                                       param1.ue, param2.ue, -->
<!--                                       two_betas = two_betas, -->
<!--                                       reward_space_lb, reward_space_ub) -->

<!--     # Create matrix to store data for each subject -->
<!--     results = data.frame(matrix(0,nrow(design),ncol(data_model))) -->
<!--     results[,1] = subjects[sub_count] -->
<!--     results[,2] = c(1:nrow(design)) -->
<!--     results[,3] = design$option_left -->
<!--     results[,4] = design$option_right -->
<!--     results[,5] = design$reward_stim_1 -->
<!--     results[,6] = design$reward_stim_2 -->
<!--     results[,7] = design$comp_number -->

<!--     # Run model over simulated data -->
<!--     sim = Pedlr_interdep(design, -->
<!--                                           alpha0, -->
<!--                                           alpha1, -->
<!--                                           interdep, -->
<!--                                           temperature, -->
<!--                                           reward_space_ub, -->
<!--                                           policy) -->

<!--     # Save model values, PE and fPE for ech trial and subject into matrix -->
<!--     results[,8] = sim$choices$choice -->
<!--     results[,9] = sim$choices$choice_prob -->
<!--     results[,10:12] = sim$values -->
<!--     results[,13:15] = sim$PE -->
<!--     results[,16:18] = sim$fPE -->

<!--     # Append all subjects -->
<!--     data_model = rbind(data_model, results) -->
<!--   } -->

<!--   # Convert to data frame (How our data will look like in the study) -->
<!--   data_model = data.frame(data_model) -->
<!--   colnames(data_model) = c('sub_id', 'trial', 'stim_1', 'stim_2', -->
<!--                            'reward_stim_1', 'reward_stim_2', 'comp_number', 'choice', 'choice_prob', -->
<!--                            'v_stim_1', 'v_stim_2', 'v_stim_3', -->
<!--                            'pe_stim_1', 'pe_stim_2', 'pe_stim_3', -->
<!--                            'fpe_stim_1', 'fpe_stim_2', 'fpe_stim_3') -->
<!--   # Sort after participants -->
<!--   data_model = data_model[order(data_model$sub_id),] -->

<!--   # Add columns specifying parameters -->
<!--   data_model$alpha0 = alpha0 -->
<!--   data_model$alpha1 = alpha1 -->
<!--   data_model$interdep = interdep -->
<!--   data_model$temperature = temperature -->
<!--   data_model$policy = policy -->

<!--   return(data_model) -->
<!-- } -->
<!-- ``` -->

<!-- - Loop over LRs, extract data, and save into .tsv-file **BUT** only if .tsv file does not exist yet -->

<!-- ```{r} -->
<!-- # See if .tsv file of bias exists already and if yes, load it, if not, create it -->
<!-- file = file.path(derivatives_path, 'interdep_model_lr_loop.tsv') -->
<!-- if(file.exists(file)){ -->

<!--   # Load created .tsv file -->
<!--   df_bias = read.table(file, sep='\t', header = TRUE) -->

<!-- }else{ -->

<!--   # Set standard parameters -->
<!--   n_subjects=40 -->
<!--   n_miniblocks=6 -->
<!--   perc_forced = 20 -->
<!--   two_betas=TRUE -->
<!--   param1.le=beta_a_le -->
<!--   param2.le=beta_b_le -->
<!--   param1.mid=gaussian_mean -->
<!--   param2.mid=gaussian_sd -->
<!--   param1.ue=beta_a_ue -->
<!--   param2.ue=beta_b_ue -->
<!--   reward_space_lb=1 -->
<!--   reward_space_ub=100 -->
<!--   interdep=0.5 -->
<!--   temperature=7 -->
<!--   policy='softmax' -->

<!--   # Create template of function output for appending outcome data frames -->
<!--   temp = bias_extraction(n_subjects=1, -->
<!--                          n_miniblocks=1, -->
<!--                          perc_forced, -->
<!--                          two_betas=two_betas, -->
<!--                          param1.le=param1.le, param2.le=param2.le, -->
<!--                          param1.mid=param1.mid, param2.mid=param2.mid, -->
<!--                          param1.ue=param1.ue, param2.ue=param2.ue, -->
<!--                          reward_space_lb=reward_space_lb, reward_space_ub=reward_space_ub, -->
<!--                          alpha0=alpha0, alpha1=alpha1, interdep=interdep, temperature=temperature, policy=policy) -->
<!--   df_bias = data.frame(matrix(NA,0,ncol(temp))) -->
<!--   colnames(df_bias) = colnames(temp) -->

<!--   # Loop over free parameters -->
<!--   for(alpha0 in seq(0.1,1,by=0.1)){ -->
<!--     for(alpha1 in seq(0.1,1,by=0.1)){ -->
<!--       for(interdep in seq(0.2,1,by=0.2)){ -->

<!--         # Run function to get data for bias calculation -->
<!--         df_bias = rbind(df_bias,  -->
<!--                         bias_extraction(n_subjects=n_subjects, -->
<!--                                         n_miniblocks=n_miniblocks, -->
<!--                                         perc_forced=perc_forced, -->
<!--                                         two_betas=two_betas, -->
<!--                                         param1.le=param1.le, param2.le=param2.le, -->
<!--                                         param1.mid=param1.mid, param2.mid=param2.mid, -->
<!--                                         param1.ue=param1.ue, param2.ue=param2.ue, -->
<!--                                         reward_space_lb=reward_space_lb, reward_space_ub=reward_space_ub, -->
<!--                                         alpha0=alpha0, alpha1=alpha1, interdep=interdep, -->
<!--                                         temperature=temperature, policy=policy)) -->
<!--       } -->
<!--     } -->
<!--   } -->

<!--   # Save into .tsv-file -->
<!--   write.table(df_bias, file, sep='\t', row.names = FALSE)   -->
<!-- } -->

<!-- ``` -->

<!-- ## Plot bias depending on LR -->

<!-- - Prepare data -->

<!-- ```{r} -->
<!-- # Melt df_bias -->
<!-- df_bias_chosen = df_bias[,c(1:12, 19:23)] -->
<!-- df_bias_chosen = melt(df_bias_chosen, id.vars=c('sub_id', -->
<!--                                                 'trial', -->
<!--                                                 'stim_1', -->
<!--                                                 'stim_2', -->
<!--                                                 'reward_stim_1', -->
<!--                                                 'reward_stim_2', -->
<!--                                                 'choice', -->
<!--                                                 'choice_prob', -->
<!--                                                 'comp_number', -->
<!--                                                 'alpha0', -->
<!--                                                 'alpha1', -->
<!--                                                 'interdep', -->
<!--                                                 'temperature', -->
<!--                                                 'policy')) -->
<!-- # Get mean/sd/sem of value for each combination of chosen stimulus and value of stimulus -->
<!-- df_bias_chosen = ddply(df_bias_chosen, -->
<!--                        .(variable, choice, alpha0, alpha1, interdep, temperature, policy), -->
<!--                        summarise, -->
<!--                        mean=mean(value), -->
<!--                        sd=sd(value), -->
<!--                        sem=sd(value)/length(value)) -->
<!-- # Focus only on relevant cases (value of stimulus in case it was chosen) -->
<!-- index = apply(df_bias_chosen, -->
<!--               1, -->
<!--               function(x) {as.numeric(substr(as.character(x[1]), 8, 8)) == as.numeric(x[2])}) -->
<!-- df_bias_chosen = df_bias_chosen[index,] -->
<!-- # Omit NA entries (resulting from last trial where there is no value to specific choice) -->
<!-- df_bias_chosen = na.omit(df_bias_chosen) -->
<!-- # Add bias column displaying difference from real mean -->
<!-- df_bias_chosen$bias = df_bias_chosen$mean -->
<!-- df_bias_chosen$bias[df_bias_chosen$choice == 1] = df_bias_chosen$bias[df_bias_chosen$choice == 1] - 100/3 -->
<!-- df_bias_chosen$bias[df_bias_chosen$choice == 2] = df_bias_chosen$bias[df_bias_chosen$choice == 2] - 100/2 -->
<!-- df_bias_chosen$bias[df_bias_chosen$choice == 3] = df_bias_chosen$bias[df_bias_chosen$choice == 3] - 2*100/3 -->
<!-- ``` -->

<!-- - Plot bias dependent on LR parameters -->

<!-- ```{r} -->
<!-- data_plot = df_bias_chosen -->
<!-- data_plot$choice = as.factor(data_plot$choice) -->

<!-- p_bias = ggplot(data_plot, aes(x=interdep, y=bias, color=choice)) + -->
<!--   theme_bw() + -->
<!--   geom_hline(yintercept=0, linetype='dashed') + -->
<!--   geom_point(alpha=0.8, size=0.8) + -->
<!--   facet_grid(cols = vars(alpha0), rows = vars(alpha1), labeller = label_both)  + -->
<!--   scale_color_manual(values = c(color$gain, color$gaussian, color$loss)) + -->
<!--   labs(main='Bias from mean in dependency of LRs and dependency parameter', -->
<!--        x='Dependency parameter', -->
<!--        y='Bias from mean') + -->
<!--   theme(panel.grid.minor = element_blank(), strip.text = element_text(size=4), -->
<!--         axis.text.x = element_text(size=5)) -->

<!-- p_bias -->
<!-- ``` -->

<!-- - Save plot -->

<!-- ```{r, warning=FALSE, message=FALSE} -->
<!-- file = '/Volumes/MPRG-Neurocode/Users/christoph/pedlr/code/simulation/figures/bias.pdf' -->
<!-- ggsave(file, plot = p_bias, height=11, width=20, unit='cm') -->
<!-- ``` -->

