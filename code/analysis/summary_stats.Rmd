---
title: "Summary Stats"
output:
  html_document:
    toc: yes
    self_contained: true
    toc_float:
      collapsed: true
      smooth_scroll: false
    toc_depth: 3
    number_sections: False
    highlight: pygments
    theme: cosmo
    code_folding: "hide"
    df_print: paged
    fig_caption: true
  pdf_document:
    toc: yes
    fig_caption: true
    latex_engine: xelatex
fig.align: "center"
header-includes:
  - \usepackage{fontspec}
  - \setmainfont{AgfaRotisSansSerif}
email: koch@mpib-berlin.mpg.de
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(data.table)
library(here)
library(magrittr)
library(ggplot2)
library(viridis)
library(binhf)
library(pwr)
library(knitr)
library(kableExtra)
```

```{r, message=FALSE}
# Get directory of repository
base_path = here::here()

# Load pre-written functions
source_path = file.path(base_path, 'code', 'utils',
                        fsep = .Platform$file.sep)
source_files = list.files(source_path, pattern = "[.][rR]$",
                          full.names = TRUE, recursive = TRUE)
invisible(lapply(source_files, function(x) source(x)))
```

```{r}
# Load data
data = Load_data() %>%
  Add_comp(.) %>%
  .[, run := as.factor(run)]

# get number of participants (to adjust figure height)
n_participants = length(unique(data$participant_id))
```

# Data quality

## Errors in forced choices

```{r, out.width='100%'}
# Summary: Mistakes on forced choices
check_fce = data %>%
  .[trial_type == 'forced',] %>%
  .[, forced_error := error] %>%
  .[, .(n_forced = length(forced),
        n_error = sum(as.numeric(forced_error)),
        group = unique(group)), by = 'participant_id'] %>%
  .[, perc_forced_error := round((n_error/n_forced) * 100, 2)] %>%
  .[, count := seq(.N), by = c('n_error', 'group')]

# Plot errors for each participant
data_plot = Prepare_data_for_plot(check_fce)
p_fce = ggplot(data = data_plot,
               aes(x = n_error,
                   label = participant_id,
                   fill = group)) +
  geom_bar() +
  labs(x = 'Number of errors during forced choices',
       y = 'N') +
  scale_x_continuous(breaks = seq(0,max(data_plot$n_error), by = 2)) +
  scale_y_continuous(breaks = seq(max(data_plot$count, by = 2))) +
  facet_wrap(~ group) +
  theme(legend.position = 'none')
Neurocodify_plot(p_fce)
```

## Number of time out trials

```{r, out.width='100%'}
check_tot = data %>%
  .[trial_type %in% c('choice', 'forced'),] %>%
  .[, .(n_timeout = sum(as.logical(timeout)),
        group = unique(group)),
        by = 'participant_id'] %>%
  .[, count := seq(.N), by = c('n_timeout', 'group')]

# Plot errors for each participant
data_plot = Prepare_data_for_plot(check_tot)
p_tot = ggplot(data = data_plot,
               aes(x = n_timeout,
                   label = participant_id,
                   fill = group)) +
  geom_bar() +
  labs(x = 'Number of timeouts across all trials',
       y = 'N') +
  scale_x_continuous(breaks = seq(0,max(data_plot$n_timeout), by = 5)) +
  scale_y_continuous(breaks = seq(0, max(data_plot$count), by = 2)) +
  facet_wrap(~group) +
  theme(legend.position = 'none')
Neurocodify_plot(p_tot)
```

# Estimation

```{r, fig.height=0.75*n_participants, out.width='100%', message=FALSE}
# Function to get running average
Get_running_avg = function(choice_option, choice_outcome, stim){
  # Initialize array keeping running average for all trials
  running_avg = c()
  
  # Loop over trials
  for(i in seq(length(choice_option))){
    # Find all choices of option so far
    idx = choice_option[1:i] == stim
    # Create mean over all stim choices so far
    trialwise_mean = mean(choice_outcome[1:i][idx], na.rm = TRUE)
    # Append running average for each trial
    running_avg = c(running_avg, trialwise_mean)
  }
  
  # Set all trials in which option has not been chosen so far to NA
  running_avg[is.nan(running_avg)] = NA
  return(running_avg)
}

check_est = data %>%
  .[, ':='(avg_1_running = Get_running_avg(choice_option = option_choice,
                                     choice_outcome = outcome,
                                     stim = 1),
           avg_2_running = Get_running_avg(choice_option = option_choice,
                                     choice_outcome = outcome,
                                     stim = 2),
           avg_3_running = Get_running_avg(choice_option = option_choice,
                                     choice_outcome = outcome,
                                     stim = 3)),
    by = c('participant_id', 'run')] %>%
  .[, forced_rare := as.numeric(as.logical(is_rare) & trial_type == 'forced' & (comp == '1v2' | comp == '2v3'))] %>%
  .[!is.na(est_1_reward),] %>%
  .[, est_trial := seq(.N), by = c('participant_id', 'run')] %>%
  data.table::melt(.,
                   id.vars = c('participant_id',
                               'group',
                               'run',
                               'est_trial',
                               'forced_rare'),
                   measure.vars = c('est_1_reward',
                                    'est_1_range',
                                    'avg_1_running',
                                    'est_2_reward',
                                    'est_2_range',
                                    'avg_2_running',
                                    'est_3_reward',
                                    'est_3_range',
                                    'avg_3_running')) %>%
  .[, est_stim := substr(variable, 5, 5)] %>%
  .[, type := substr(variable, 7, 9)] %>%
  .[type == 'rew', type := 'reward'] %>%
  .[type == 'ran', type := 'range'] %>%
  .[type == 'run', type := 'r_avg'] %>%
  data.table::dcast(., participant_id + group + run + est_trial + forced_rare + est_stim ~ type,
                    value.var = 'value')

# Merge true means with estimation
check_est_diff = check_est %>%
  # Get difference between estimation and true mean
  .[, diff_from_true := reward - r_avg]
```

## Difference from truth in estimation {.tabset}

### Across groups {.tabset}

#### Mean

```{r, out.width='100%'}
data_plot = Prepare_data_for_plot(check_est_diff)
p_est_diff = ggplot(data = data_plot,
                    aes(x = est_trial,
                        y = diff_from_true,
                        color = est_stim)) +
  geom_path(alpha = 0.3, aes(group = participant_id)) +
  stat_summary(fun = 'mean', geom = 'line', size = 1, na.rm = TRUE, color = 'black') +
  stat_summary(fun = 'mean', geom = 'point', size = 1.5, na.rm = TRUE, fill = 'white', color = 'black', shape = 21) +
    geom_hline(yintercept = 0,
               size = 0.3) +
  scale_color_viridis(option = 'D', discrete = TRUE) +
  facet_grid(run~ est_stim) +
  theme(legend.position = 'top')
Neurocodify_plot(p_est_diff)
```

#### Median

```{r, out.width='100%'}
data_plot = Prepare_data_for_plot(check_est_diff)
p_est_diff = ggplot(data = data_plot,
                    aes(x = est_trial,
                        y = diff_from_true,
                        color = est_stim)) +
  geom_path(alpha = 0.3, aes(group = participant_id)) +
  stat_summary(fun = 'median', geom = 'line', size = 1, na.rm = TRUE, color = 'black') +
  stat_summary(fun = 'median', geom = 'point', size = 1.5, na.rm = TRUE, fill = 'white', color = 'black', shape = 21) +
    geom_hline(yintercept = 0,
               size = 0.3) +
  scale_color_viridis(option = 'D', discrete = TRUE) +
  facet_grid(run~ est_stim) +
  theme(legend.position = 'top')
Neurocodify_plot(p_est_diff)
```

### Within group {.tabset}

#### Mean

```{r}
data_plot = Prepare_data_for_plot(check_est_diff)
p_est_diff = ggplot(data = data_plot,
                    aes(x = est_trial,
                        y = diff_from_true,
                        color = est_stim)) +
  geom_path(alpha = 0.3, aes(group = participant_id)) +
  stat_summary(fun = 'mean', geom = 'line', size = 0.5, na.rm = TRUE, color = 'black') +
  stat_summary(fun = 'mean', geom = 'point', size = 1, na.rm = TRUE, fill = 'white', color = 'black', shape = 21) +
  geom_hline(yintercept = 0,
             size = 0.3) +
  scale_color_viridis(option = 'D', discrete = TRUE) +
  facet_grid(run ~ group + est_stim) +
  theme(legend.position = 'top')
Neurocodify_plot(p_est_diff)
```

#### Median

```{r}
data_plot = Prepare_data_for_plot(check_est_diff)
p_est_diff = ggplot(data = data_plot,
                    aes(x = est_trial,
                        y = diff_from_true,
                        color = est_stim)) +
  geom_path(alpha = 0.3, aes(group = participant_id)) +
  stat_summary(fun = 'median', geom = 'line', size = 0.5, na.rm = TRUE, color = 'black') +
  stat_summary(fun = 'median', geom = 'point', size = 1, na.rm = TRUE, fill = 'white', color = 'black', shape = 21) +
  geom_hline(yintercept = 0,
             size = 0.3) +
  scale_color_viridis(option = 'D', discrete = TRUE) +
  facet_grid(run ~ group + est_stim) +
  theme(legend.position = 'top')
Neurocodify_plot(p_est_diff)
```

### Individual difference from truth

```{r, fig.height=0.75*n_participants, out.width='100%'}
data_plot = Prepare_data_for_plot(check_est_diff)
p_est_diff = ggplot(data = data_plot,
                    aes(x = est_trial,
                        y = diff_from_true,
                        color = as.factor(run))) +
  geom_hline(yintercept = 0,
             linetype = 'dashed') +
  geom_path() +
  scale_color_viridis(option = 'D', discrete = TRUE) +
  facet_grid(group + participant_id ~ est_stim) +
  theme(legend.position = 'top')
Neurocodify_plot(p_est_diff)
```

### Individual estimates

```{r, fig.height=0.75*n_participants, out.width='100%'}
data_plot = Prepare_data_for_plot(check_est)
p_est = ggplot(data = data_plot,
               aes(x = est_trial,
                   y = reward,
                   color = est_stim)) +
  geom_path(aes(y = r_avg),
             linetype = 'dashed') +
  geom_ribbon(aes(ymin = reward - range,
                  ymax = reward + range),
              alpha = 0.3) +
  geom_point(size = 0.8) +
  geom_path() +
  labs(x = 'Estimation Trial',
       y = 'Estimate') +
  facet_grid(group + participant_id ~ run + est_stim) +
  scale_color_viridis(option = 'D', discrete = TRUE) +
  theme(legend.position = 'none')
Neurocodify_plot(p_est)
```


### Individual estimates after rare

```{r, fig.height=0.75*n_participants, out.width='100%'}
data_plot = Prepare_data_for_plot(check_est)
p_ear = ggplot(data = data_plot,
               aes(x = est_trial,
                   y = reward)) +
  geom_path(aes(y = r_avg),
             linetype = 'dashed') +
  geom_ribbon(aes(ymin = reward - range,
                  ymax = reward + range),
              alpha = 0.3) +
  geom_path() +
  geom_point(aes(color = as.factor(forced_rare)),
             size = 0.8) +
  labs(x = 'Estimation Trial',
       y = 'Estimate') +
  facet_grid(group + participant_id ~ run + est_stim) +
  scale_color_viridis(option = 'D', discrete = TRUE) +
  theme(legend.position = 'top')
Neurocodify_plot(p_ear)
```

# RT

```{r, fig.height=0.75*n_participants, out.width='100%'}
check_rt = data %>%
  .[, trial := seq(.N),
    by = c('participant_id', 'run')] %>%
  .[timeout == FALSE, ] %>%
  data.table::melt(.,
                   id.vars = c('participant_id',
                               'group',
                               'run',
                               'trial',
                               'trial_type',
                               'comp'),
                   measure.vars = 'rt')
```

## RT difference 1v2 and 2v3 {.tabset}

### Line plot

```{r, out.width='100%', fig.show='hold'}
check_rt_diff = check_rt %>%
  .[, .(median_rt = median(value),
        mean_rt = mean(value)),
    by = c('participant_id', 'group', 'run', 'trial_type', 'comp')] %>%
  .[comp %in% c('1v2', '2v3')]

data_plot = Prepare_data_for_plot(check_rt_diff)
p_rtd_median = ggplot(data = data_plot,
                      aes(x = comp,
                          y = median_rt,
                          color = group)) +
  geom_point() +
  geom_line(aes(group = participant_id)) +
  labs(title = 'Median') +
  facet_grid(run ~ trial_type + group)
Neurocodify_plot(p_rtd_median)

data_plot = Prepare_data_for_plot(check_rt_diff)
p_rtd_mean = ggplot(data = data_plot,
                    aes(x = comp,
                        y = mean_rt,
                        color = group)) +
  geom_point() +
  geom_line(aes(group = participant_id)) +
  labs(title = 'Mean') +
  facet_grid(run ~ trial_type + group)
Neurocodify_plot(p_rtd_mean)
```

Time-outs excluded from calculation.

### Difference

```{r, out.width='100%', fig.show='hold'}
check_rt_diff_comp = check_rt_diff %>%
  data.table::dcast(participant_id + group + run + trial_type ~ comp,
                    value.var = c('median_rt', 'mean_rt')) %>%
  .[, ':='(median_1v2m2v3 = median_rt_1v2 - median_rt_2v3,
           mean_1v2m2v3 = mean_rt_1v2 - mean_rt_2v3)] %>%
  .[, run := as.factor(run)]

data_plot = Prepare_data_for_plot(check_rt_diff_comp)
p_rtc_median = ggplot(data = data_plot,
                      aes(x = run,
                          y = median_1v2m2v3,
                          color = group)) +
  geom_hline(yintercept = 0,
             linetype = 'dashed') +
  geom_point() +
  scale_y_continuous(limits = c(-max(abs(data_plot$median_1v2m2v3)),
                                max(abs(data_plot$median_1v2m2v3)))) +
  labs(title = 'Difference Median (1v2 - 2v3)') +
  facet_wrap(~group + trial_type)
Neurocodify_plot(p_rtc_median)

data_plot = Prepare_data_for_plot(check_rt_diff_comp)
p_rtc_mean = ggplot(data = data_plot,
                      aes(x = run,
                          y = mean_1v2m2v3,
                          color = group)) +
  geom_hline(yintercept = 0,
             linetype = 'dashed') +
  geom_point() +
  scale_y_continuous(limits = c(-max(abs(data_plot$mean_1v2m2v3)),
                                max(abs(data_plot$mean_1v2m2v3)))) +
  labs(title = 'Difference Mean (1v2 - 2v3)') +
  facet_wrap(~group + trial_type)
Neurocodify_plot(p_rtc_mean)
```

### Individual RT

```{r, fig.height=0.75*n_participants, out.width='100%'}
data_plot = Prepare_data_for_plot(check_rt)
p_rt = ggplot(data = data_plot,
       aes(x = comp,
           y = value)) +
  geom_jitter(width = 0.1,
              size = 0.2) +
  stat_summary(geom = 'path',
               fun = 'median',
               color = 'black',
               size = 0.5,
               group = 'participant_id') +
  stat_summary(geom = 'point',
               fun = 'median',
               color = 'black',
               fill = 'white',
               shape = 21,
               size = 2) +
  labs(x = 'Trial Type',
       y = 'RT') +
  facet_grid(group + participant_id ~ trial_type + run)
Neurocodify_plot(p_rt)
```


# Correctness

```{r, fig.height=0.75*n_participants, out.width='100%'}
check_noc = data %>%
  .[trial_type == 'choice',] %>%
  .[, correct_choice := if(option_left > option_right) 'left' else 'right',
    by = c('participant_id', 'run', 'trial')] %>%
  .[, correct := correct_choice == choice] %>%
  # Get percentage of correct choices (exclude timeouts from overall trials)
  .[, .(perc_correct = sum(as.numeric(correct), na.rm = TRUE) / length(which(!is.na(as.numeric(correct))))),
    by = c('participant_id', 'group', 'run', 'comp')]
```

## Difference between comparisons including asymmetric stimulus {.tabset}

### Line plot

```{r, out.width='100%'}
check_noc_crit = check_noc %>%
  .[comp %in% c('1v2', '2v3'),]

data_plot = Prepare_data_for_plot(check_noc_crit)
p_noc_diff_comp_line = ggplot(data = data_plot,
                              aes(x = comp,
                                  y = perc_correct,
                                  color = group)) +
  geom_point() +
  geom_line(aes(group = participant_id)) +
  facet_grid(run ~ group)
Neurocodify_plot(p_noc_diff_comp_line)
```

### Difference

```{r, out.width='100%'}
check_noc_diff = check_noc %>%
  # Only select critical comparisons
  .[comp %in% c('1v2', '2v3'),] %>%
  data.table::dcast(participant_id + group + run ~ paste('mean_', comp, sep = ''),
                    value.var = 'perc_correct') %>%
  .[, diff_1v2m2v3 := mean_1v2 - mean_2v3]

data_plot = Prepare_data_for_plot(check_noc_diff)
p_noc_diff_comp_diff = ggplot(data = data_plot,
                         aes(x = run,
                             y = diff_1v2m2v3,
                             color = group)) +
  geom_hline(yintercept = 0,
             linetype = 'dashed') +
  geom_point() +
  scale_y_continuous(limits = c(-max(abs(data_plot$diff_1v2m2v3)),
                                max(abs(data_plot$diff_1v2m2v3)))) +
  facet_wrap(~group) +
  labs(title = 'Difference between crit comparisons (1v2 - 2v3)')
Neurocodify_plot(p_noc_diff_comp_diff)
```

### Individual correctness

```{r, fig.height=0.75*n_participants, out.width='100%'}
data_plot = Prepare_data_for_plot(check_noc)
p_noc = ggplot(data = data_plot,
               aes(x = comp,
                   y = perc_correct,
                   group = participant_id,
                   color = group)) +
  geom_line() +
  geom_point() +
  labs(x = '%-correct',
       y = 'Comparison') +
  facet_grid(group + participant_id ~ run) +
  theme(legend.position = 'top')
Neurocodify_plot(p_noc)
```


## Non-optimal between run 1 and 2

```{r, out.width='100%'}
data_plot = Prepare_data_for_plot(check_noc)
p_noc_diff_run = ggplot(data = data_plot,
                        aes(x = run,
                            y = perc_correct,
                            group = participant_id,
                            color = group)) +
  geom_point() +
  geom_line() +
  facet_grid(comp ~ group)
Neurocodify_plot(p_noc_diff_run)
```
