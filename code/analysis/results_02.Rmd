---
title: "Summary Stats"
output:
  html_document:
    toc: yes
    self_contained: true
    toc_float:
      collapsed: true
      smooth_scroll: false
    toc_depth: 3
    number_sections: False
    highlight: pygments
    theme: cosmo
    code_folding: "hide"
    df_print: paged
    fig_caption: true
  pdf_document:
    toc: yes
    fig_caption: true
    latex_engine: xelatex
fig.align: "center"
header-includes:
  - \usepackage{fontspec}
  - \setmainfont{AgfaRotisSansSerif}
email: koch@mpib-berlin.mpg.de
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(data.table)
library(here)
library(magrittr)
library(ggplot2)
library(viridis)
library(binhf)
library(pwr)
library(knitr)
library(kableExtra)
library(sdamr)
library(gghalves)
library(lme4)
library(emmeans)
library(papeR)
```

```{r, message=FALSE}
# Get directory of repository
base_path = here::here()

# Load pre-written functions
source_path = file.path(base_path, 'code', 'utils',
                        fsep = .Platform$file.sep)
source_files = list.files(source_path, pattern = "[.][rR]$",
                          full.names = TRUE, recursive = TRUE)
invisible(lapply(source_files, function(x) source(x)))

# Get plot colors/linetypes
custom_guides = Get_plot_guides()
```

```{r}
data = Load_model_fits() %>%
  Apply_exclusion_criteria(.) %>%
  .[, ':='(participant_id = as.factor(participant_id),
           group = as.factor(group),
           run = as.factor(run),
           para = as.factor(para),
           model = as.factor(model))] %>%
  .[, real_iter := seq(.N),
      by = c('participant_id',
             'group',
             'run',
             'model',
             'para')]
# Sort model levels by number of parameters
data$model = factor(data$model, levels = c('Rw', 'Pedlr_simple', 'Pedlr', 'Pedlr_fixdep', 'Pedlr_interdep'))

# get number of participants (to adjust figure height)
n_participants = length(unique(data$participant_id))
```

# Model comparison

```{r}
data_aic = data %>%
  .[,n_para := .N,
    by = c('participant_id', 'group', 'run', 'real_iter', 'model')] %>%
  data.table::dcast(.,
                    participant_id + group + run + real_iter + second_ll + model + n_para ~ para,
                    value.var = 'second_solution') %>%
  # Calculate AIC
  .[, AIC := (2*n_para) + (2*second_ll)]

# Get min aic model
data_best_fit = data_aic %>%
  .[, .SD[which.min(AIC)],
    by = c('participant_id', 'group', 'run', 'real_iter')] %>%
  # Take only first iteration (no variability in fits)
  .[real_iter == 1,]
```

## Plot

```{r}
data_plot = Prepare_data_for_plot(data_best_fit)
dodge_width = 0.2

ggplot(data = data_plot,
       aes(x = model,
           color = group,
           fill = group)) +
  geom_bar(stat = 'count',
                 width = dodge_width,
                 position = position_dodge(width = dodge_width)) +
  facet_wrap(~run)
```

```{r}
# Count winning model
data_fit_count = data_best_fit %>%
  .[, .(n_best_fit = .N),
    by = c('group', 'run', 'model')] %>%
  .[order(rank(group), rank(run)), ]
```


- look at fit as function of behavioral results
  - e.g. effect of rare outcome ==> fit of pedlr

```{r}
data_pedler_simple = data_best_fit %>%
  .[model == 'Pedlr_simple',] %>%
  data.table::melt(id.vars = c('participant_id', 'group', 'run', 'real_iter', 'second_ll', 'model', 'AIC'),
                   measure.vars = c('alpha1', 'temperature'),
                   variable.name = 'para')
```

```{r}
data_plot = Prepare_data_for_plot(data_aic) %>%
  .[real_iter == 1 & model == 'Pedlr_simple'] %>%
  data.table::melt(id.vars = c('participant_id', 'group', 'run', 'real_iter', 'second_ll', 'model', 'AIC'),
                   measure.vars = c('alpha1', 'temperature'),
                   variable.name = 'para')

dodge_width = 0.3

p_alpha1 = ggplot(data = data_plot[para == 'alpha1'],
       aes(x = run,
           y = log(value),
           color = group,
           fill = group)) +
  geom_point(position = position_jitterdodge(dodge.width = dodge_width,
                                             jitter.width = dodge_width,
                                             jitter.height = 0,
                                             seed = 666)) +
  geom_boxplot(width = dodge_width/2,
               outlier.shape = NA,
               color = 'black',
               position = position_dodge(width = dodge_width)) +
  gghalves::geom_half_violin(position = position_nudge(-dodge_width),
                             alpha = 0.5,
                             color = NA) +
  scale_color_manual(values = custom_guides) +
  scale_fill_manual(values = custom_guides)

Neurocodify_plot(p_alpha1)
```

- Could maybe move model estimation to log space (so in the model its not a1 * PE BUT e^a1 * PE) so 0.00004 and 0.0000000007 could actually be distinguished

```{r}
data_plot = Prepare_data_for_plot(data_pedler_simple)

dodge_width = 0.3

p_alpha1 = ggplot(data = data_plot[para == 'alpha1'],
       aes(x = run,
           y = value,
           color = group,
           fill = group)) +
  geom_point(position = position_jitterdodge(dodge.width = dodge_width,
                                             jitter.width = dodge_width,
                                             jitter.height = 0,
                                             seed = 666)) +
  geom_boxplot(width = dodge_width/2,
               outlier.shape = NA,
               color = 'black',
               position = position_dodge(width = dodge_width)) +
  gghalves::geom_half_violin(position = position_nudge(-dodge_width),
                             alpha = 0.5,
                             color = NA) +
  scale_color_manual(values = custom_guides) +
  scale_fill_manual(values = custom_guides)

Neurocodify_plot(p_alpha1)
```


---

# Nico

```{r}
data = Load_model_fits_nico() %>%
  Apply_exclusion_criteria(.) %>%
  .[, ':='(participant_id = as.factor(participant_id),
           group = as.factor(group),
           run = as.factor(run),
           para = as.factor(para),
           model = as.factor(model))]

# Sort model levels by number of parameters
data$model = factor(data$model, levels = c('Rw', 'Pedlr_simple', 'Pedlr', 'Pedlr_fixdep'))
```


```{r}
data_aic = data %>%
  .[,n_para := .N,
    by = c('participant_id', 'group', 'run', 'iter', 'model')] %>%
  data.table::dcast(.,
                    participant_id + group + run + iter + ll + model + n_para ~ para,
                    value.var = 'solution') %>%
  # Calculate AIC
  .[, AIC := (2*n_para) + (2*ll)]

# Get min aic model
data_best_fit = data_aic %>%
  .[, .SD[which.min(AIC)],
    by = c('participant_id', 'group', 'run', 'iter')] %>%
  # Take only first iteration (no variability in fits)
  .[iter == 1,]
```

```{r}
data_plot = Prepare_data_for_plot(data_best_fit)
dodge_width = 0.2

ggplot(data = data_plot,
       aes(x = model,
           color = group,
           fill = group)) +
  geom_bar(stat = 'count',
                 width = dodge_width,
                 position = position_dodge(width = dodge_width)) +
  facet_wrap(~run)
```

# Two main things to put in:

- Relating behavioral results to model fits (alpha 1)

# Look at difference in behavioral predicitin between modles

- how many trials get predicted for different choices between models
