---
title: "Model fitting Summary"
output:
  html_document:
    toc: yes
    self_contained: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 3
    number_sections: False
    highlight: pygments
    theme: cosmo
    code_folding: "hide"
    df_print: paged
    fig_caption: true
  pdf_document:
    toc: yes
    fig_caption: true
    latex_engine: xelatex
fig.align: "center"
header-includes:
  - \usepackage{fontspec}
  - \setmainfont{AgfaRotisSansSerif}
email: koch@mpib-berlin.mpg.de
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(data.table)
library(here)
library(magrittr)
library(ggplot2)
library(viridis)
library(plotly)
library(plyr)
library(gghalves)
```

```{r}
# Get directory of repository
base_path = here::here()

# Load pre-written functions
source_path = file.path(base_path, 'code', 'utils',
                        fsep = .Platform$file.sep)
source_files = list.files(source_path, pattern = "[.][rR]$",
                          full.names = TRUE, recursive = TRUE)
invisible(lapply(source_files, function(x) source(x)))

# Get custom plot guides
custom_guides = Get_plot_guides()
```


```{r}
# Load data
data = Load_model_fits()
bla = Load_data()
data$group = ''
for(id in unique(bla$participant_id)){
  data[participant_id == id]$group = unique(bla[participant_id == id]$group)
}
data = data %>%
  # Join iterations of across jobs and within jobs
    .[, real_iter := seq(.N),
      by = c('participant_id',
             'group',
             'run',
             'model',
             'para')]

# Get number of participants
n_participants = length(unique(data$participant_id))

# Get all designs
all_designs = Load_data()


# Get model comparison data
data_aic = data %>%
  .[,n_para := .N,
    by = c('participant_id', 'group', 'run', 'real_iter', 'model')] %>%
  data.table::dcast(.,
                    participant_id + group + run + real_iter + second_ll + model + n_para ~ para,
                    value.var = 'second_solution') %>%
  # Calculate AIC
  .[, AIC := (2*n_para) + (2*second_ll)] %>%
  # Get min aic model
  .[, .SD[which.min(AIC)],
    by = c('participant_id', 'group', 'run', 'real_iter')] %>%
  .[, model := as.factor(model)]
```

```{r}
# Get mean fits
data_mean = data %>%
  .[, .(mean_solution = mean(second_solution),
        sd_solution = sd(second_solution),
        mean_ll = mean(second_ll),
        sd_ll = sd(second_ll)),
    by = c('participant_id', 'group', 'run', 'model', 'para')]

# Get AIC scores of mean fits
data_mean_aic = data_mean %>%
  .[,n_para := .N,
    by = c('participant_id', 'group', 'run', 'model')] %>%
  data.table::dcast(.,
                    participant_id + group + run + mean_ll + model + n_para ~ para,
                    value.var = 'mean_solution') %>%
  # Calculate AIC
  .[, AIC := (2*n_para) + (2*mean_ll)] %>%
  # Get min aic model
  .[, .SD[which.min(AIC)],
    by = c('participant_id', 'group', 'run')] %>%
  .[, model := as.factor(model)]
```


# Parameter distributions

Over within-subject mean of all fitting iterations

```{r, out.width='100%'}
data_plot = data_mean %>%
  .[para == 'alpha', para := 'alpha0'] %>%
  Prepare_data_for_plot()

p_dist_para = ggplot(data = data_plot[para != 'temperature'],
       aes(x = mean_solution,
           fill = group)) +
  geom_density(alpha = 0.7,
                color = 'transparent') +
  scale_fill_manual(values = custom_guides) +
  facet_grid(para ~ model,
             scales = 'free_y') +
  theme(legend.position = 'top',
        axis.title.x = element_blank())
p_dist_para = Neurocodify_plot(p_dist_para)

p_dist_temp = ggplot(data = data_plot[para == 'temperature'],
       aes(x = mean_solution,
           fill = group)) +
  geom_density(alpha = 0.7,
                color = 'transparent') +
  scale_fill_manual(values = custom_guides) +
  facet_grid(para ~ model) +
  theme(legend.position = 'none',
        strip.background.x = element_blank(),
        strip.text.x = element_blank())
p_dist_temp = Neurocodify_plot(p_dist_temp)

p_dist = cowplot::plot_grid(p_dist_para, p_dist_temp,
                   ncol = 1,
                   rel_heights = c(3,1),
                   axis = 'rl',
                   align = 'v')
p_dist
```

# Best fitting model

```{r}
# Count best fitting models
setkey(data_mean_aic, group, run, model)
data_plot = data_mean_aic %>%
    .[data.table::CJ(group, run, model, unique = TRUE), .(count = .N),
    by = .EACHI] %>%
  Prepare_data_for_plot()

# Plot best fitting models for both age groups
p_best_fit = ggplot(data = data_plot,
                    aes(x = model,
                        y = count,
                        fill = group,
                        color = group)) +
  geom_col(color = NA,
           position = position_dodge()) +
  scale_fill_manual(values = custom_guides) +
  scale_color_manual(values = custom_guides) +
  facet_wrap(~run)
p_best_fit = Neurocodify_plot(p_best_fit)
p_best_fit
```


# Age comparison

```{r}
data_plot = data_mean %>%
  .[para == 'alpha', para := 'alpha0'] %>%
  Prepare_data_for_plot()

p_age_comp = ggplot(data = data_plot[para != 'temperature',],
       aes(x = run,
           y = mean_solution,
           fill = group,
           color = group)) +
  geom_point(size = 0.5,
             position = position_jitterdodge(jitter.width = 0.08,
                                             jitter.height = 0,
                                             dodge.width = 0.3)) +
  geom_boxplot(width = 0.15,
               color = 'black',
               outlier.shape = NA,
               show.legend = FALSE,
               position = position_dodge(width = 0.3)) +
  stat_summary(fun = 'mean',
               geom = 'point',
               na.rm = TRUE,
               shape = 23,
               inherit.aes = TRUE,
               fill = 'white',
               size = 1.5,
               stroke = 0.5,
               position = position_dodge(width = 0.3),
               show.legend = FALSE) +
  gghalves::geom_half_violin(side = 1,
                             color = 'transparent',
                             width = 0.5,
                             alpha = 0.7,
                             position = position_nudge(x = 0.2),
                             show.legend = FALSE) +
  scale_fill_manual(values = custom_guides) +
  scale_color_manual(values = custom_guides) +
  facet_grid(model ~ para,
             scales = 'free_x')

p_age_comp = Neurocodify_plot(p_age_comp)
p_age_comp
```


# Fitting consistency

```{r}
Plot_prepare_consistency = function(data){
  data_plot = data %>%
    data.table::melt(., id.vars = c('participant_id',
                                    'group',
                                    'file',
                                    'iter',
                                    'run',
                                    'name_design_r1',
                                    'name_design_r2',
                                    'model',
                                    'para',
                                    'first_status',
                                    'first_ll',
                                    'second_status',
                                    'second_ll'),
                     measure.vars = c('first_x0',
                                      'second_solution'),
                     value.name = 'val') %>%
    .[, variable := factor(variable, levels = c('first_x0',
                                                'second_solution'))] %>%
    # Join iterations of across jobs and within jobs
    .[, real_iter := seq(.N),
      by = c('participant_id',
             'group',
             'run',
             'name_design_r1',
             'name_design_r2',
             'model',
             'para',
             'variable')] %>%
    # Delete previous iteration columns
    .[, ':='(iter = NULL,
             file = NULL)] %>%
    data.table::dcast(.,
                      participant_id + 
                        group +
                        real_iter +
                        run + 
                        name_design_r1 + 
                        name_design_r2 + 
                        model +
                        first_status + 
                        first_ll + 
                        second_status + 
                        second_ll + 
                        variable ~ paste0('value_', para), value.var = 'val')
  
  return(data_plot)
}
```

## Rw

```{r, out.width='100%', fig.height=n_participants}
data_plot = Plot_prepare_consistency(data[model == 'Rw'])

p_con_rw = ggplot(data = data_plot,
       aes(x = value_alpha,
           y = value_temperature,
           group = real_iter)) +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0,10)) +
  geom_path(color = 'black',
            size = 0.2,
            alpha = 0.2) +
  geom_point(data = data_plot[variable == 'second_solution'],
             size = 0.8,
             color = 'black',
             alpha = 0.5) +
  facet_grid(participant_id ~ run) +
  theme(legend.position = 'top')
p_con_rw
```

## Pedlr_simple

```{r}
data_plot = Plot_prepare_consistency(data[model == 'Pedlr_simple'])

ggplot(data = data_plot,
       aes(x = value_alpha1,
           y = value_temperature,
           fill = variable,
           shape = variable,
           group = real_iter)) +
  scale_fill_manual(values = c('white', 'black')) +
  scale_shape_manual(values = c(21, 24)) +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0,10)) +
  # geom_path(color = 'black',
  #           size = 0.2,
  #           alpha = 0.3) +
  geom_point(size = 0.8,
             stroke = 0.3,
             color = 'black',
             alpha = 0.5) +
  facet_grid(participant_id ~ run) +
  theme(legend.position = 'bottom')
```


## Pedlr

```{r, warning=FALSE, fig.show='hold'}
data_plot = Plot_prepare_consistency(data[model == 'Pedlr'])

# Set axes names
axx <- list(
  title = "alpha0"
)
axy <- list(
  title = 'alpha1'
)
axz <- list(
  title = "temp"
)

for(pid in unique(data_plot$participant_id)){
  data_plot_i = data_plot[participant_id == pid]
  fig = plotly::plot_ly(x = data_plot_i$value_alpha0,
                        y = data_plot_i$value_alpha1,
                        z = data_plot_i$value_temperature,
                        type = "scatter3d",
                        mode = 'markers',
                        color = data_plot_i$variable,
                        size = (nchar(as.character(data_plot_i$variable)) + data_plot_i$run) * 0.1) %>%
    plotly::layout(title = unique(data_plot_i$participant_id),
                   scene = list(xaxis=axx,yaxis=axy,zaxis=axz))
  
  print(fig)
}
```

## Pedlr_fixdep

```{r, warning=FALSE, fig.show='hold'}
data_plot = Plot_prepare_consistency(data[model == 'Pedlr_fixdep'])

# Set axes names
axx <- list(
  title = "alpha0"
)
axy <- list(
  title = 'alpha1'
)
axz <- list(
  title = "temp"
)

for(pid in unique(data_plot$participant_id)){
  data_plot_i = data_plot[participant_id == pid]
  fig = plotly::plot_ly(x = data_plot_i$value_alpha0,
                        y = data_plot_i$value_alpha1,
                        z = data_plot_i$value_temperature,
                        type = "scatter3d",
                        mode = 'markers',
                        color = data_plot_i$variable,
                        size = (nchar(as.character(data_plot_i$variable)) + data_plot_i$run) * 0.1) %>%
    plotly::layout(title = unique(data_plot_i$participant_id),
                   scene = list(xaxis=axx,yaxis=axy,zaxis=axz))
  
  print(fig)
}
```


## Pedlr_interdep

```{r, warning=FALSE, fig.show='hold'}
data_plot = Plot_prepare_consistency(data[model == 'Pedlr_interdep'])

# Set axes names
axx <- list(
  title = "alpha0"
)
axy <- list(
  title = 'alpha1'
)
axz <- list(
  title = "temp"
)

for(pid in unique(data_plot$participant_id)){
  data_plot_i = data_plot[participant_id == pid]
  fig = plotly::plot_ly(x = data_plot_i$value_alpha0,
                        y = data_plot_i$value_alpha1,
                        z = data_plot_i$value_temperature,
                        type = "scatter3d",
                        mode = 'markers',
                        color = data_plot_i$variable,
                        size = (nchar(as.character(data_plot_i$variable)) + data_plot_i$run) * 0.1) %>%
    plotly::layout(title = unique(data_plot_i$participant_id),
                   scene = list(xaxis=axx,yaxis=axy,zaxis=axz))
  
  print(fig)
}
```

# Central questions

```{r}
# Get data for relationship between a0 and a1
data_rel = Plot_prepare_consistency(data) %>%
  .[variable == 'second_solution']

# Get percentage of correct choices for each comparison type
data_corr = all_designs %>%
  Add_comp(.) %>%
  .[, trial := seq(.N),
    by = c('participant_id', 'run')] %>%
  .[trial_type == 'choice',] %>%
  .[, correct_choice := if(option_left > option_right) 'left' else 'right',
    by = c('participant_id', 'run', 'trial')] %>%
  .[, correct := correct_choice == choice] %>%
  # Get percentage of correct choices (exclude timeouts from overall trials)
  .[, .(perc_correct = sum(as.numeric(correct), na.rm = TRUE) / length(which(!is.na(as.numeric(correct))))),
    by = c('participant_id', 'run', 'comp')] %>%
  data.table::dcast(., participant_id + run ~ paste0('corr_', comp), value.var = 'perc_correct') %>%
  # Add correctness of choices to model fit
  data.table::merge.data.table(data, ., by = c('participant_id', 'run')) %>%
  # Join iterations for each file
  .[, real_iter := seq(.N),
      by = c('participant_id',
             'run',
             'name_design_r1',
             'name_design_r2',
             'model',
             'para')] %>%
  # parse to wide format for plotting
  data.table::dcast(., participant_id + run + real_iter + model + corr_1v2 + corr_2v3 + corr_1v3 + second_ll ~ para,
                    value.var = 'second_solution')

# Get mean ratings of participants
data_rat = all_designs %>%
  # Filter for trials in which rating was done
  .[!is.na(est_1_reward),] %>%
  .[, rating_trial := seq(.N),
    by = c('participant_id', 'run')] %>%
  # Get mean of ratings
  .[, .(mean_est_1 = mean(est_1_reward),
        mean_est_2 = mean(est_2_reward),
        mean_est_3 = mean(est_3_reward)),
    by = c('participant_id', 'run')] %>%
  # Merge with correctness data
  data.table::merge.data.table(data_corr, ., by = c('participant_id', 'run'))

```

## Correlation between a0 and a1? 

### Pedlr {.tabset}

#### Plot

```{r}
data_plot = data_rel[model == 'Pedlr']

ggplot(data = data_plot,
       aes(x = value_alpha0,
           y = value_alpha1)) +
  geom_point() +
  geom_smooth(method = 'lm',
              formula = y ~ x, 
              fill = NA,
              size = 0.5,
              alpha = 0.5) +
  facet_wrap(~ run)
```

#### Stats

```{r}
data_rat[model == 'Pedlr'] %>%
  .[, .( r = cor.test(alpha0, alpha1)$estimate,
         p = cor.test(alpha0, alpha1)$p.value,
         method = cor.test(alpha0, alpha1)$method,
         df = cor.test(alpha0, alpha1)$parameter,
         statisic = cor.test(alpha0, alpha1)$statistic),
    by = c('run', 'real_iter')]
```

### Pedlr_fixdep {.tabset}

#### Plot

```{r}
data_plot = data_rel[model == 'Pedlr_fixdep']

ggplot(data = data_plot,
       aes(x = value_alpha0,
           y = value_alpha1,
           group = real_iter)) +
  geom_point() +
  geom_smooth(method = 'lm',
              formula = y ~ x, 
              fill = NA,
              size = 0.5,
              alpha = 0.5) +
  facet_wrap(~ run)
```

#### Stats

```{r}
data_rat[model == 'Pedlr_fixdep'] %>%
  .[, .( r = cor.test(alpha0, alpha1)$estimate,
         p = cor.test(alpha0, alpha1)$p.value,
         method = cor.test(alpha0, alpha1)$method,
         df = cor.test(alpha0, alpha1)$parameter,
         statisic = cor.test(alpha0, alpha1)$statistic),
    by = c('run', 'real_iter')]
```

### Pedlr_interdep {.tabset}

#### Plot

```{r}
data_plot = data_rel[model == 'Pedlr_interdep']

ggplot(data = data_plot,
       aes(x = value_alpha0,
           y = value_alpha1,
           group = real_iter)) +
  geom_point() +
  geom_smooth(method = 'lm',
              formula = y ~ x, 
              fill = NA,
              size = 0.5,
              alpha = 0.5) +
  facet_wrap(~ run)
```

#### Stats

```{r}
data_rat[model == 'Pedlr_interdep'] %>%
  .[, .( r = cor.test(alpha0, alpha1)$estimate,
         p = cor.test(alpha0, alpha1)$p.value,
         method = cor.test(alpha0, alpha1)$method,
         df = cor.test(alpha0, alpha1)$parameter,
         statisic = cor.test(alpha0, alpha1)$statistic),
    by = c('run', 'real_iter')]
```

## Higher a1 = more errors in 1v2?

### Reference

```{r}
ggplot(data_rat[model == 'Rw'],
       aes(x = alpha,
           y = corr_1v2,
           group = real_iter)) +
  geom_point() +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0,1)) +
  facet_wrap(~ run)
```


### Pedlr_simple {.tabset}

#### Plot

```{r}
ggplot(data_rat[model == 'Pedlr_simple'],
       aes(x = alpha1,
           y = corr_1v2,
           group = real_iter)) +
  geom_point() +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0,1)) +
  facet_wrap(~ run)
```

#### Stats

```{r}
data_rat[model == 'Pedlr_simple'] %>%
  .[, .( r = cor.test(alpha1, corr_1v2)$estimate,
         p = cor.test(alpha1, corr_1v2)$p.value,
         method = cor.test(alpha1, corr_1v2)$method,
         df = cor.test(alpha1, corr_1v2)$parameter,
         statisic = cor.test(alpha1, corr_1v2)$statistic),
    by = c('run', 'real_iter')]
```

### Pedlr {.tabset}

#### Plot

```{r}
ggplot(data_rat[model == 'Pedlr'],
       aes(x = alpha1,
           y = corr_1v2,
           group = real_iter)) +
  geom_point() +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0,1)) +
  facet_wrap(~ run)
```

#### Stats

```{r}
data_rat[model == 'Pedlr'] %>%
  .[, .( r = cor.test(alpha1, corr_1v2)$estimate,
         p = cor.test(alpha1, corr_1v2)$p.value,
         method = cor.test(alpha1, corr_1v2)$method,
         df = cor.test(alpha1, corr_1v2)$parameter,
         statisic = cor.test(alpha1, corr_1v2)$statistic),
    by = c('run', 'real_iter')]
```

### Pedlr_fixdep {.tabset}

#### Plot

```{r}
ggplot(data_rat[model == 'Pedlr_fixdep'],
       aes(x = alpha1,
           y = corr_1v2,
           group = real_iter)) +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  geom_point() +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0,1)) +
  facet_wrap(~ run)
```

#### Stats

```{r}
data_rat[model == 'Pedlr_fixdep'] %>%
  .[, .( r = cor.test(alpha1, corr_1v2)$estimate,
         p = cor.test(alpha1, corr_1v2)$p.value,
         method = cor.test(alpha1, corr_1v2)$method,
         df = cor.test(alpha1, corr_1v2)$parameter,
         statisic = cor.test(alpha1, corr_1v2)$statistic),
    by = c('run', 'real_iter')]
```

### Pedlr_interdep {.tabset}

#### Plot

```{r}
ggplot(data_rat[model == 'Pedlr_interdep'],
       aes(x = alpha1,
           y = corr_1v2,
           group = real_iter)) +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  geom_point() +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0,1)) +
  facet_wrap(~ run)
```

#### Stats

```{r}
data_rat[model == 'Pedlr_interdep'] %>%
  .[, .( r = cor.test(alpha1, corr_1v2)$estimate,
         p = cor.test(alpha1, corr_1v2)$p.value,
         method = cor.test(alpha1, corr_1v2)$method,
         df = cor.test(alpha1, corr_1v2)$parameter,
         statisic = cor.test(alpha1, corr_1v2)$statistic),
    by = c('run', 'real_iter')]
```

## Higher a1 = Higher difference in correct responses 1v2 and 2v3?

### Reference (Rw)

#### Plot

```{r}
ggplot(data_rat[model == 'Rw'],
       aes(x = alpha,
           y = corr_2v3 - corr_1v2,
           group = real_iter)) +
  geom_point() +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(-1,1)) +
  facet_wrap(~ run)
```


### Pedlr_simple

#### Plot

```{r}
ggplot(data_rat[model == 'Pedlr_simple'],
       aes(x = alpha1,
           y = corr_2v3 - corr_1v2,
           group = real_iter)) +
  geom_point() +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(-1,1)) +
  facet_wrap(~ run)
```

### Pedlr

#### Plot

```{r}
ggplot(data_rat[model == 'Pedlr'],
       aes(x = alpha1,
           y = corr_2v3 - corr_1v2,
           group = real_iter)) +
  geom_point() +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(-1,1)) +
  facet_wrap(~ run)
```

### Pedlr_fixdep

#### Plot

```{r}
ggplot(data_rat[model == 'Pedlr_fixdep'],
       aes(x = alpha1,
           y = corr_2v3 - corr_1v2,
           group = real_iter)) +
  geom_point() +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(-1,1)) +
  facet_wrap(~ run)
```

### Pedlr_interdep

#### Plot

```{r}
ggplot(data_rat[model == 'Pedlr_interdep'],
       aes(x = alpha1,
           y = corr_2v3 - corr_1v2,
           group = real_iter)) +
  geom_point() +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(-1,1)) +
  facet_wrap(~ run)
```


## More PEDLR evidence = less correct 1v2? {.tabset}

```{r}
data_stats = data_rat[model %in% c('Rw', 'Pedlr')] %>%
  .[, ll := second_ll] %>%
  data.table::dcast(.,
                    participant_id + run + real_iter + corr_1v2 + corr_2v3 + mean_est_2 ~ model,
                    value.var = c('ll', 'alpha1')) %>%
  .[, ':='(diff_ll = ll_Rw - ll_Pedlr,
           diff_corr = corr_1v2 - corr_2v3)]
```

### Plot

```{r}
ggplot(data_stats,
       aes(x = diff_ll,
           y = corr_1v2,
           group = real_iter)) +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  geom_point() +
  facet_wrap(~ run)
```


### Stats

```{r}
data_stats %>%
  .[, .(r = cor.test(diff_ll, corr_1v2)$estimate,
         p = cor.test(diff_ll, corr_1v2)$p.value,
         method = cor.test(diff_ll, corr_1v2)$method,
         df = cor.test(diff_ll, corr_1v2)$parameter,
         statisic = cor.test(diff_ll, corr_1v2)$statistic),
    by = c('run', 'real_iter')]
```

## More PEDLR evidence = more difference between 1v2 and 2v3? {.tabset}

### Plot

```{r}
ggplot(data_stats,
       aes(x = diff_ll,
           y = diff_corr,
           group = real_iter)) +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  geom_point() +
  facet_wrap(~ run)
```


### Stats

```{r}
data_stats %>%
  .[, .(r = cor.test(diff_ll, diff_corr)$estimate,
        p = cor.test(diff_ll, diff_corr)$p.value,
        method = cor.test(diff_ll, diff_corr)$method,
        df = cor.test(diff_ll, diff_corr)$parameter,
        statisic = cor.test(diff_ll, diff_corr)$statistic),
    by = c('run', 'real_iter')]
```

## More evidence for Pedlr = higher alpha 1? {.tabset}

### Plot

```{r}
ggplot(data_stats,
       aes(x = diff_ll,
           y = alpha1_Pedlr,
           group = real_iter)) +
  geom_smooth(method = 'lm',
              formula = y ~ x,
              fill = NA) +
  geom_point() +
  facet_wrap(~ run)
```


### Stats

```{r}
data_stats %>%
  .[, .(r = cor.test(diff_ll, alpha1_Pedlr)$estimate,
        p = cor.test(diff_ll, alpha1_Pedlr)$p.value,
        method = cor.test(diff_ll, alpha1_Pedlr)$method,
        df = cor.test(diff_ll, alpha1_Pedlr)$parameter,
        statisic = cor.test(diff_ll, alpha1_Pedlr)$statistic),
    by = c('run', 'real_iter')]
```


```{r}
# # are differenes in estimates values for bandit 2 related to ratings ?
# cor.test(modeldf$RW_value2 - modeldf$PEDLR_value2, modeldf$Rating2)
# cor.test(modeldf$PEDLR_value2, modeldf$Rating2)
# cor.test(modeldf$RW_value2, modeldf$Rating2)
```

---

# Model comparison {.tabset}

```{r}
data_aic = data %>%
  # Join iterations of across jobs and within jobs
    .[, real_iter := seq(.N),
      by = c('participant_id',
             'run',
             'model',
             'para')] %>%
  .[,n_para := .N,
    by = c('participant_id', 'run', 'real_iter', 'model')] %>%
  data.table::dcast(.,
                    participant_id + run + real_iter + second_ll + model + n_para ~ para,
                    value.var = 'second_solution') %>%
  # Calculate AIC
  .[, AIC := (2*n_para) + (2*second_ll)] %>%
  # Get min aic model
  .[, .SD[which.min(AIC)],
    by = c('participant_id', 'run', 'real_iter')] %>%
  .[, model := as.factor(model)]
```

## Winning model

```{r}
ggplot(data = data_aic[real_iter == 1],
       aes(x = model)) +
         geom_bar() +
  facet_grid(~run)
```


## Consistency

```{r, out.width='100%'}
ggplot(data = data_aic,
       aes(x = real_iter,
           y = model)) +
  geom_path() +
  geom_point(size = 0.3) +
  facet_grid(participant_id ~ run)
```



<!-- # Model vs. participants -->

<!-- ```{r} -->
<!-- # Function to append model values as columns to design file -->
<!-- Append_model_values = function(data, model_output){ -->
<!--   data$model_choice = model_output$choices$choice -->
<!--   data$model_choice_prob = model_output$choices$choice_prob -->
<!--   data$model_value_1 = model_output$values$stim_1 -->
<!--   data$model_value_2 = model_output$values$stim_2 -->
<!--   data$model_value_3 = model_output$values$stim_3 -->
<!--   data$model_pe_1 = model_output$PE$stim_1 -->
<!--   data$model_pe_2 = model_output$PE$stim_2 -->
<!--   data$model_pe_3 = model_output$PE$stim_3 -->
<!--   data$model_fpe_1 = model_output$fPE$stim_1 -->
<!--   data$model_fpe_2 = model_output$fPE$stim_2 -->
<!--   data$model_fpe_3 = model_output$fPE$stim_3 -->

<!--   return(data) -->
<!-- } -->

<!-- # Get data for best fitting model -->
<!-- data_best = Get_best_fit(data) -->

<!-- # Simulate data based on best fitting parameters -->
<!-- data_best_fitting_paras = data.table() -->
<!-- for(id in unique(all_designs$participant_id)){ -->
<!--   for(run in unique(all_designs$run)){ -->
<!--     # Rw -->
<!--     sim = Rw(design = all_designs[participant_id == id & run == run], -->
<!--              params.alpha = data_best[participant_id == id & run == run & model == 'Rw', -->
<!--                                       second_solution_alpha], -->
<!--              params.temperature = data_best[participant_id == id & run == run & model == 'Rw', -->
<!--                                             second_solution_temperature], -->
<!--              params.reward_space_ub = 100, -->
<!--              choice_policy = 'softmax', -->
<!--              init_values = c(50,50,50)) -->
<!--     temp = all_designs[participant_id == id & run == run] -->
<!--     temp$model = 'Rw' -->
<!--     temp = Append_model_values(data = temp, model_output = sim) -->
<!--     data_best_fitting_paras = rbind(data_best_fitting_paras, temp) -->

<!--     # Pedlr -->
<!--     sim = Pedlr(design = all_designs[participant_id == id & run == run], -->
<!--                 params.alpha0 = data_best[participant_id == id & run == run & model == 'Pedlr', -->
<!--                                           second_solution_alpha0], -->
<!--                 params.alpha1 = data_best[participant_id == id & run == run & model == 'Pedlr', -->
<!--                                           second_solution_alpha1], -->
<!--                 params.temperature = data_best[participant_id == id & run == run & model == 'Pedlr', -->
<!--                                                second_solution_temperature], -->
<!--                 params.reward_space_ub = 100, -->
<!--                 choice_policy = 'softmax', -->
<!--                 init_values = c(50,50,50)) -->
<!--     temp = all_designs[participant_id == id & run == run] -->
<!--     temp$model = 'Pedlr' -->
<!--     temp = Append_model_values(data = temp, model_output = sim) -->
<!--     data_best_fitting_paras = rbind(data_best_fitting_paras, temp) -->

<!--     # Pedlr_interdep -->
<!--     sim = Pedlr_interdep(design = all_designs[participant_id == id & run == run], -->
<!--                          params.alpha0 = data_best[participant_id == id & run == run & model == 'Pedlr_interdep', -->
<!--                                                    second_solution_alpha0], -->
<!--                          params.alpha1 = data_best[participant_id == id & run == run & model == 'Pedlr_interdep', -->
<!--                                                    second_solution_alpha1], -->
<!--                          params.interdep = data_best[participant_id == id & run == run & model == 'Pedlr_interdep', -->
<!--                                                      second_solution_interdep], -->
<!--                          params.temperature = data_best[participant_id == id & run == run & model == 'Pedlr_interdep', -->
<!--                                                         second_solution_temperature], -->
<!--                          params.reward_space_ub = 100, -->
<!--                          choice_policy = 'softmax', -->
<!--                          init_values = c(50,50,50)) -->
<!--     temp = all_designs[participant_id == id & run == run] -->
<!--     temp$model = 'Pedlr_interdep' -->
<!--     temp = Append_model_values(data = temp, model_output = sim) -->
<!--     data_best_fitting_paras = rbind(data_best_fitting_paras, temp) -->
<!--   } -->
<!-- } -->
<!-- ``` -->

<!-- ```{r} -->
<!-- Plot_prepare_correspondence = function(data){ -->
<!--   # Get columns of estimations -->
<!--   est_cols = c('est_1_reward', 'est_2_reward', 'est_3_reward', -->
<!--                'model_value_1', 'model_value_2', 'model_value_3') -->

<!--   data_plot = data %>% -->
<!--     .[, trial := seq(.N), -->
<!--       by = c('participant_id', 'run', 'model')] %>% -->
<!--     .[, (est_cols) := lapply(.SD, as.numeric), .SDcols = est_cols] %>% -->
<!--     data.table::melt(., -->
<!--                      id.vars = c('participant_id', 'run', 'model', 'trial'), -->
<!--                      measure.vars = c('est_1_reward', 'est_2_reward', 'est_3_reward', -->
<!--                                       'model_value_1', 'model_value_2', 'model_value_3')) %>% -->
<!--     .[!is.na(value),] %>% -->
<!--     .[, ':='(type = unlist(strsplit(as.character(variable), split = '_'))[1], -->
<!--              stim = sort(unlist(strsplit(as.character(variable), split = '_')))[1]), -->
<!--       by = c('participant_id', 'run', 'model', 'trial', 'variable')] %>% -->
<!--     .[, ':='(type = as.factor(type), -->
<!--              stim = as.factor(stim))] -->

<!--   return(data_plot) -->
<!-- } -->

<!-- # Prepare all data for plotting correspondence -->
<!-- data_plot = Plot_prepare_correspondence(data_best_fitting_paras) -->
<!-- ``` -->

<!-- ```{r, out.width='100%', fig.height=n_participants} -->
<!-- ggplot(data = data_plot[type == 'est'], -->
<!--        aes(x = trial, -->
<!--            y = value)) + -->
<!--   geom_line(color = 'black', -->
<!--             linetype = 'dashed') + -->
<!--   geom_point(color = 'black', -->
<!--              size = 0.3, -->
<!--              alpha = 0.5) + -->
<!--   geom_line(data = data_plot[type == 'model'], -->
<!--             aes(color = model), -->
<!--             linetype = 'solid', -->
<!--             alpha = 0.7) + -->
<!--   scale_color_manual(values = c('red', 'blue', 'yellow')) + -->
<!--   facet_grid(participant_id ~ run + stim) + -->
<!--   theme(legend.position = 'top') -->
<!-- ``` -->

<!-- # Parameter relations -->

<!-- ## Pedlr -->

<!-- ### alpha0 vs. alpha1 -->

<!-- ```{r, out.width='100%', fig.height=n_participants} -->
<!-- data_plot = Plot_prepare_consistency(data[model == 'Pedlr']) %>% -->
<!--   .[variable == 'second_solution'] -->
<!-- ggplot(data = data_plot, -->
<!--        aes(x = value_alpha0, -->
<!--            y = value_alpha1)) + -->
<!--   geom_point() + -->
<!--   facet_grid( ~ run) -->
<!-- ``` -->


