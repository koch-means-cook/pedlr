---
title: "Model fitting Summary"
output:
  html_document:
    toc: yes
    self_contained: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 3
    number_sections: False
    highlight: pygments
    theme: cosmo
    code_folding: "hide"
    df_print: paged
    fig_caption: true
  pdf_document:
    toc: yes
    fig_caption: true
    latex_engine: xelatex
fig.align: "center"
header-includes:
  - \usepackage{fontspec}
  - \setmainfont{AgfaRotisSansSerif}
email: koch@mpib-berlin.mpg.de
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(data.table)
library(here)
library(magrittr)
library(ggplot2)
library(viridis)
library(plotly)
```

```{r}
# Get directory of repository
base_path = here::here()

# Load pre-written functions
source_path = file.path(base_path, 'code', 'utils',
                        fsep = .Platform$file.sep)
source_files = list.files(source_path, pattern = "[.][rR]$",
                          full.names = TRUE, recursive = TRUE)
invisible(lapply(source_files, function(x) source(x)))
```

```{r}
Plot_prepare = function(data){
  data_plot = data %>%
  data.table::melt(., id.vars = c('participant_id',
                                  'file',
                                  'iter',
                                  'task_version',
                                  'name_design_r1',
                                  'name_design_r2',
                                  'model',
                                  'para',
                                  'first_status',
                                  'first_ll',
                                  'second_status',
                                  'second_ll'),
                   measure.vars = c('first_x0',
                                    'second_solution'),
                   value.name = 'val') %>%
  .[, variable := factor(variable, levels = c('first_x0',
                                              'second_solution'))] %>%
  # Join iterations of across jobs and within jobs
  .[, real_iter := seq(.N),
    by = c('participant_id',
           'task_version',
           'name_design_r1',
           'name_design_r2',
           'para',
           'variable')] %>%
  # Delete previous iteration columns
  .[, ':='(iter = NULL,
           file = NULL)] %>%
  data.table::dcast(.,
                    participant_id + 
                      real_iter +
                      task_version + 
                      name_design_r1 + 
                      name_design_r2 + 
                      first_status + 
                      first_ll + 
                      second_status + 
                      second_ll + 
                      variable ~ paste0('value_', para), value.var = 'val')
  
  return(data_plot)
}
```


```{r}
# Load data
data = Load_model_fits()
data_rw = data[model == 'Rw']
data_pedlr = data[model == 'Pedlr']
data_pedlr_interdep = data[model == 'Pedlr_interdep']
```

# Rw

## Fitting consistency

```{r, out.width='100%'}
data_plot = Plot_prepare(data_rw)

ggplot(data = data_plot,
       aes(x = value_alpha,
           y = value_temperature,
           fill = variable,
           shape = variable,
           group = real_iter)) +
  scale_fill_manual(values = c('white', 'black')) +
  scale_shape_manual(values = c(21, 24)) +
  geom_path(color = 'black',
            size = 0.2,
            alpha = 0.3) +
  geom_point(size = 0.8,
             stroke = 0.3,
             color = 'black',
             alpha = 0.5) +
  facet_grid(participant_id ~ task_version) +
  theme(legend.position = 'bottom')
```

# Pedlr

```{r, warning=FALSE, fig.show='hold'}
data_plot = Plot_prepare(data_pedlr)

for(pid in unique(data_plot$participant_id)){
  data_plot_i = data_plot[participant_id == pid]
  fig = plotly::plot_ly(x = data_plot_i$value_alpha0,
                        y = data_plot_i$value_alpha1,
                        z = data_plot_i$value_temperature,
                        type = "scatter3d",
                        mode = 'markers',
                        color = data_plot_i$variable,
                        size = nchar(as.character(data_plot_i$variable)) * 0.1) %>%
    plotly::layout(title = unique(data_plot_i$participant_id))
  
  print(fig)
}
```

# Pedlr_interdep

```{r, warning=FALSE, fig.show='hold'}
data_plot = Plot_prepare(data_pedlr_interdep)

for(pid in unique(data_plot$participant_id)){
  data_plot_i = data_plot[participant_id == pid]
  fig = plotly::plot_ly(x = data_plot_i$value_alpha0,
                        y = data_plot_i$value_alpha1,
                        z = data_plot_i$value_temperature,
                        type = "scatter3d",
                        mode = 'markers',
                        color = data_plot_i$variable,
                        size = nchar(as.character(data_plot_i$variable)) * 0.1) %>%
    plotly::layout(title = unique(data_plot_i$participant_id))
  
  print(fig)
}
```
